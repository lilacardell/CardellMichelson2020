---
title: "Data Analysis"
author: "Lila Cardell"
date: "2/26/2021"
output: html_document
---


Load packages
```{r setup, echo=FALSE,warning=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE,
	root.dir = "C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R"
)
options(scipen=999)
set.seed(101484)
###  Check for and load Packages   ###
#writeLines('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', con = "~/.Renviron")

## Clear worksace
rm(list = ls())
gc()

## This function will check if a package is installed, and if not, install it
pkgTest  =  function(x) {
  if (!require(x, character.only = TRUE))
  {
    install.packages(x, dep = TRUE)
    if(!require(x, character.only = TRUE)) stop("Package not found")
  }
}

## These lines load the required packages
packages  =  c('data.table','tidyverse','haven','foreign','stargazer','lubridate','knitr','xtable','tables','kableExtra','car','stringr','styler','readxl','magrittr','sjmisc','ggplot2','ggpubr','ggnewscale','bookdown','scales','quantmod','distr6','plyr','esquisse','forcats','ggrepel','gdata','stringdist','SparseM','quantreg','mfx','erer','margins','moments',"lemon",'rnaturalearth','DescTools')
## you can add more packages here

lapply(packages, pkgTest)

rm(packages,pkgTest)

```


0. Import dataset
```{r import0,echo=FALSE}

setwd("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final")

maize_prices<-read_dta("./Data/maizeprices_260221.dta")


```


1. Assign planting and harvest season months
```{r assign1,echo=FALSE}

#Reminder: note h1x,h2x,p1x,p2x if planting or harvest seasons that cross the end of the year, e.g. harvest starts in Dec and ends in Jan 
maize<-maize_prices%>%
   filter(!is.na(price_real))%>% #mostly 2020 data and Somalia which is missing CPI data
filter(!(market=="Kirundo"&year==2015&month==1&commodity=="Maize (white) - Retail"))%>% #errors in WFP dataset
filter(!(market=="Dar Es Salaam"&year==2009&month==7&commodity=="Maize - Wholesale"))%>%
   mutate(endharvest1=if_else(month==main_harvest_end,main_harvest_end,as.numeric(NA)),
          endharvest2=if_else(month==second_harvest_end,second_harvest_end,as.numeric(NA)),
          yyyymm=paste(year,formatC(month,width=2,flag="0"),sep="-"))%>%
  mutate(monthtype1=if_else(note_p1x==0&month>=main_plant_start & month<=main_plant_end,paste0("planting1_",year),#for nonwrapped planting season
                          if_else(note_p1x==1&month>=main_plant_start,paste0("planting1_",year), #for months at the end of the year
                          if_else(note_p1x==1&month<=main_plant_end,paste0("planting1_",year-1), #assume months at the beginning of the year belong with prior year's planting season
                    if_else(note_h1x==0&month>=main_harvest_start & month<=main_harvest_end,paste0("harvest1_",year),#for nonwrapped harvest season
                            if_else(note_h1x==1&month>=main_harvest_start,paste0("harvest1_",year), #for months at the end of the year
                               if_else(note_h1x==1&month<=main_harvest_end,paste0("harvest1_",year-1),"")))))),#assume months at the beginning of the year belong with prior year's harvest season
      monthtype2=if_else(note_p2x==0&month>=second_plant_start & month<=second_plant_end,paste0("planting2_",year), #for nonwrapped planting season
                               if_else(note_p2x==1&month>=second_plant_start,paste0("planting2_",year), #for months at the end of the year
                               if_else(note_p2x==1&month<=second_plant_end,paste0("planting2_",year-1), #for months at the beginning of the year
                       if_else(note_h2x==0&month>=second_harvest_start & month<=second_harvest_end,paste0("harvest2_",year),#for nonwrapped harvest season
                               if_else(note_h2x==1&month>=second_harvest_start,paste0("harvest2_",year), #for months at the end of the year
                               if_else(note_h2x==1&month<=second_harvest_end,paste0("harvest2_",year-1),"")))))))%>% #for months at the beginning of the year
separate(commodity,c("commodity","market_type"), " - ")%>%
   mutate(date=parse_date_time(yyyymm,"ym"))%>%
  dplyr::select(country,region,market,lat,lon,commodity,market_type,currency,year,month,price_real,yield_kgha,monthtype1,monthtype2,note_1,note_2,endharvest1,endharvest2,date)
 
yield=maize%>%
  dplyr::select(country,year,yield_kgha)%>%
  group_by(country,year)%>%
  slice(1)%>%
  ungroup()


```


2. Calculate returns using harvest end/min and max planting
```{r returns2,echo=FALSE}

#Note_1/2==1 means main/second planting season occurs before main/second harvest season in a calendar year,as analysis is harvest==>planting/lean, so shift planting season crop year -1 

con1 = maize%>% 
   separate(monthtype1,c("monthtype1","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  filter(!is.na(cropyear))%>% #find all the planting or harvest months for the main season
  arrange(country,commodity,market_type,market,year,month)%>% 
  group_by(country,commodity,market_type,market,cropyear,monthtype1)%>% #group by crop year to find the price within harvest/planting months for that crop year
  dplyr::summarise(minprice=min(price_real,na.rm=TRUE),maxprice=max(price_real,na.rm=TRUE),
                   endprice=last(price_real,na.rm=TRUE),note_1=mean(note_1))%>%    
  ungroup()%>%
    mutate(cropyear=if_else(note_1==1 & monthtype1=="planting1",cropyear-1,cropyear))%>% #shift planting season back for crossed crop years so that returns are from harvest to subsequent planting season
    unite("temp",c("country","market","commodity","market_type"),sep="_")%>%
  pivot_wider(names_from = monthtype1,values_from=c("minprice","maxprice","endprice"))%>%
  dplyr::rename(hmin1=minprice_harvest1,hend1=endprice_harvest1,
                pmax1=maxprice_planting1)%>%
  dplyr::select(temp,cropyear,hmin1,hend1,pmax1)%>%
  mutate(returns1_c=(pmax1-hmin1)/hmin1,returns1=(pmax1-hend1)/hend1,
         noarb1_c=if_else(pmax1<=hmin1,1,0),noarb1=if_else(pmax1<=hend1,1,0))%>% #calculate returns from last harvest month and minimum harvest price
  filter(!is.na(returns1))

#~7500 observations

#repeat for second maize season
con2 = maize%>% 
   separate(monthtype2,c("monthtype2","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  filter(!is.na(cropyear))%>% #find all the planting or harvest months for the second season
  arrange(country,commodity,market_type,market,year,month)%>% 
  group_by(country,commodity,market_type,market,cropyear,monthtype2)%>% #group by crop year to find the price within harvest/planting months for that crop year
  dplyr::summarise(minprice=min(price_real,na.rm=TRUE),maxprice=max(price_real,na.rm=TRUE),
                   endprice=last(price_real,na.rm=TRUE),note_2=mean(note_2))%>%    
  ungroup()%>%
    mutate(cropyear=if_else(note_2==1 & monthtype2=="planting2",cropyear-1,cropyear))%>% #shift planting season back for crossed crop years so that returns are from harvest to subsequent planting season
  unite("temp",c("country","market","commodity","market_type"),sep="_")%>%
  pivot_wider(names_from = monthtype2,values_from=c("minprice","maxprice","endprice"))%>%
  dplyr::rename(hmin2=minprice_harvest2,hend2=endprice_harvest2,
                pmax2=maxprice_planting2)%>%
  dplyr::select(temp,cropyear,hmin2,hend2,pmax2)%>%
  mutate(returns2_c=(pmax2-hmin2)/hmin2,returns2=(pmax2-hend2)/hend2,
         noarb2_c=if_else(pmax2<=hmin2,1,0),noarb2=if_else(pmax2<=hend2,1,0))%>% #calculate returns from last harvest month and minimum harvest price
  filter(!is.na(returns2))

#~2000 observations

returns_con=full_join(con1,con2,by=c("temp","cropyear"))%>%
  separate("temp",c("country","market","commodity","market_type"),sep="_")%>%
  arrange(country,market,commodity,market_type,cropyear)%>%
  left_join(yield,by=c("country","cropyear"="year"))


rm(con1,con2,yield)

```




3. Calculate intratemporal returns by varying the number of months after harvest end
```{r harvest.calc,echo=FALSE,include=FALSE}

#isolate the month of harvest end for the main season and determine the price quintile for the country and market type
hend1=maize%>%
  filter(is.finite(endharvest1))%>%
  mutate(hend_date1=date,hend_price1=price_real)%>%
  dplyr::select(country,region,market,commodity,market_type,contains("hend"))%>%
  group_by(country,market_type)%>%
  dplyr::mutate(z_h1=scale(hend_price1),h1_d=as.factor(paste0("d",ntile(hend_price1,10))),h1_q=paste0("q",ntile(hend_price1,5)))%>%
  ungroup()

decile=c("d1","d2","d3","d4","d5","d6","d7","d8","d9","d10")
hend1$h1_d<-reorder.factor(hend1$h1_d,new.order=decile)

#isolate the month of harvest end for the second season and determine the price quintile for the country and market type
hend2=maize%>%
  filter(is.finite(endharvest2))%>%
  mutate(hend_date2=date,hend_price2=price_real)%>%
  dplyr::select(country,region,market,commodity,market_type,contains("hend"))%>%
  group_by(country,market_type)%>%
  dplyr::mutate(z_h2=scale(hend_price2),h2_d=as.factor(paste0("d",ntile(hend_price2,10))),h2_q=paste0("q",ntile(hend_price2,5)))%>%
  ungroup()

hend2$h2_d<-reorder.factor(hend2$h2_d,new.order=decile)

#rejoin the harvest month end and calculate returns for every month from the harvest end, keeping only the months within a year after harvest, and calculate returns
returns_dur1=maize%>%  
  left_join(hend1,by=c("country","region","market","commodity","market_type"))%>%
  mutate(duration1=interval(hend_date1,date),returns1=(price_real-hend_price1)/hend_price1,arb1=if_else(price_real>hend_price1,1,0))%>%
  mutate(duration1=duration1%/%months(1),noarb1=if_else(arb1==0,1,0))%>%
  filter(duration1%in%1:12)%>%
  dplyr::select(-lat,-lon,-currency,-note_1,-note_2,-endharvest1,-endharvest2,-monthtype1,-monthtype2)

#repeat for second season
returns_dur2=maize%>%
  left_join(hend2,by=c("country","region","market","commodity","market_type"))%>%
    mutate(duration2=interval(hend_date2,date),returns2=(price_real-hend_price2)/hend_price2,arb2=if_else(price_real>hend_price2,1,0))%>%
  mutate(duration2=duration2%/%months(1),noarb2=if_else(arb2==0,1,0))%>%
filter(duration2%in%1:12)%>%
  dplyr::select(-lat,-lon,-currency,-note_1,-note_2,-endharvest1,-endharvest2,-monthtype1,-monthtype2)

#rejoin the returns 
returns_dur=full_join(returns_dur1,returns_dur2,by=c("country","region","market","commodity","market_type","year","month","price_real","yield_kgha","date"))%>%
  arrange(country,market,commodity,year,month)

rm(hend1,hend2,returns_dur1,returns_dur2)

```



4. Look at measures of skewness and kurtosis in all markets
```{r skew4,echo=FALSE,include=FALSE}


skew_mkt=maize%>%
  group_by(country,market,market_type)%>%
  dplyr::summarise(cv=(mean(price_real)/sd(price_real)),
                   skew=skewness(price_real),kurt=kurtosis(price_real),nobs=n())%>%
  mutate(n_skew=if_else(skew<=0,1,0),n_kurt=if_else(kurt<=0,1,0))%>%
  ungroup()

#no evidence of negative kurtosis in any markets

skew_country=skew_mkt%>%
  group_by(country,market_type)%>%
  filter(n()>1)%>%
  dplyr::summarise(across(c(cv,kurt,skew),mean,na.rm=TRUE),across(starts_with("n"),sum,na.rm=TRUE),n_mkt=n())%>%
  dplyr::mutate(n_skew_pct=n_skew/n_mkt,n_kurt_pct=n_kurt/n_mkt)%>%
  dplyr::select(country,market_type,n_mkt,nobs,cv,skew,n_skew_pct,kurt,n_kurt_pct)%>%
   dplyr::mutate(across(c(n_skew_pct,n_kurt_pct),~paste0(sprintf("%.1f",.*100),"%")),
            across(c(cv,skew,kurt),round,3))%>%
  ungroup()

#need to drop markets with only one observation

print=xtable(skew_country,type="latex")
names(print)<-c("Country","Market Type","Markets","Market-Months","Coefficient of \n Variation","Average Market Skewness ","Percent Markets Negative Skew", "Kurtosis","Percent Markets Negative Kurtosis")
print(print,file="C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/skew_kurt_022521.tex",include.rownames=FALSE)


rm(skew_mkt,skew_country,print)

```



5. Map of markets
```{r map5,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

markets=maize%>%
  dplyr::select(country,market,market_type,lat,lon)%>%
   mutate(country=revalue(country,c("DR Congo"="Democratic Republic of the Congo","CAR"="Central African Republic")))

countries=markets%>%
  group_by(country)%>%
  dplyr::summarise(across(lat:lon,mean))


world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
    geom_sf(fill="antiquewhite") +
    geom_point(data=markets, aes(x = lon, y = lat,fill=market_type), size = 1, 
        shape = 23)+
   geom_label_repel(data = countries, aes(x=lon,y=lat, label = country), size =2,nudge_x= 0.15,
    direction    = "y",
    segment.size = 0.2)+
    coord_sf(xlim = c(-20,50), ylim = c(-35, 25), expand = FALSE)+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.25), panel.background = element_rect(fill = "aliceblue"),
        legend.position=c(0.35,0.35),legend.background = element_rect(fill="aliceblue"),legend.title=element_blank(),
        axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.title.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.y=element_blank())


ggsave("market_map.PNG",width=12,height=9)

rm(markets,countries,world)

```


6. Create summary data sets
```{r summary6,echo=FALSE}


## Duration (FULL SET) data set for primary maize season, keep markets with at least two years of data for each duration
duration1=returns_dur%>%
  filter(is.finite(returns1))%>%
  group_by(country,commodity,market_type,market,duration1)%>%
  filter(n()>1)%>%#Mauritania drops out
  ungroup()

#Duration (MARKET LEVEL)
duration1_mkt=duration1%>%
  group_by(country,commodity,market_type,market,duration1)%>%
  dplyr::summarise(returns_m=mean(returns1),
                   n_season=n(),n_neg=sum(noarb1))%>%
  ungroup()%>%
  mutate(pct_season=n_neg/n_season)%>%
  dplyr::select(-n_neg)


## Seasonal returns for primary and second maize season data set, keep markets with at least three crop years
season1=returns_con%>%
   filter(is.finite(returns1))%>%
  group_by(country,commodity,market_type,market)%>%
  filter(n()>1)%>%#Mauritania drops out
  ungroup()%>%
  dplyr::select(1:5,hmin1,pmax1,returns1,returns1_c,noarb1,noarb1_c,yield_kgha)

season2=returns_con%>%
   filter(is.finite(returns2))%>%
  group_by(country,commodity,market_type,market)%>%
  filter(n()>1)%>%
  ungroup()%>%
  dplyr::select(1:5,hmin2,pmax2,returns2,returns2_c,noarb2,noarb2_c,yield_kgha)

season=season1%>%
  full_join(season2,by=c("country","commodity","market","market_type","yield_kgha","cropyear"))



#Seasonal returns (MARKET LEVEL)
season_mkt=season%>%
  group_by(country,commodity,market_type,market)%>%
  dplyr::summarise(across(starts_with("returns"),list(e=mean),na.rm=TRUE,.names = "{.fn}.{.col}"),
                  across(starts_with("noarb"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                  n.yrs1=length(cropyear[is.finite(returns1)]),n.yrs2=length(cropyear[is.finite(returns2)]))%>%
  ungroup()%>%
  mutate(pct_season1=n_season_noarb1/n.yrs1,pct_season1_c=n_season_noarb1_c/n.yrs1,
         pct_season2=n_season_noarb2/n.yrs2,pct_season2_c=n_season_noarb2_c/n.yrs2)%>%
 dplyr::select(-contains("n_"))

#%>%dplyr::rename(n_season=n.returns1)

#973 markets 

pctp=function(x){
  y=mean(x[x>0],na.rm=TRUE)
}

pctn=function(x){
  y=mean(x[x<=0],na.rm=TRUE)
}

#Seasonal returns (COUNTRYLEVEL)
season_country=season%>%
  group_by(country,commodity,market_type)%>%
   dplyr::summarise(across(starts_with("returns"),list(e=mean,pos=~pctp(.x),neg=~pctn(.x)),na.rm=TRUE,.names = "{.fn}.{.col}"),
                    across(starts_with("noarb"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                   n.mkt1=n_distinct(market[is.finite(returns1)]),n.mkt2=n_distinct(market[is.finite(returns2)]),
                   n.yrs1=length(market[is.finite(returns1)]),n.yrs2=length(market[is.finite(returns2)]))%>%
       ungroup()%>%
   mutate(pct_season1=n_season_noarb1/n.yrs1,pct_season1_c=n_season_noarb1_c/n.yrs1,
         pct_season2=n_season_noarb2/n.yrs2,pct_season2_c=n_season_noarb2_c/n.yrs2)%>%
  dplyr::select(-starts_with("n_"))

#make a list of years covered
all_years=season%>%
  arrange(country,market_type,cropyear)%>%
  group_by(country,market_type)%>%
  dplyr::summarise(minyr=min(cropyear),maxyr=max(cropyear))%>%
  mutate(years=paste(minyr,maxyr,sep="-"))%>%
dplyr::select(country,market_type,years)
 
#add list of years to country data
season_country=season_country%>%
  left_join(all_years,by=c("country","market_type"))%>%
  dplyr::select(country,commodity,market_type,years,contains("1"),contains("2"))


rm(all_years,season1,season2,pctn,pctp)
 
```


7. Print summary datasets
```{r print7,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

#summary datasets for main season
sum_retail1=season_country%>%
  filter(market_type=="Retail")%>%
  dplyr::select(country,years,contains("1"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)

sum_wholesale1=season_country%>%
  filter(market_type=="Wholesale")%>%
 dplyr::select(country,years,contains("1"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)

#main season (retail)
retail1=season_country%>%
  filter(market_type=="Retail")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)%>%
  rbind(sum_retail1)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))


#main season (wholesale)
wholesale1=season_country%>%
filter(market_type=="Wholesale")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)%>%
  rbind(sum_wholesale1)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))


#summary datasets for second season
sum_retail2=season_country%>%
  filter(market_type=="Retail")%>%
  dplyr::select(country,years,contains("2"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)

sum_wholesale2=season_country%>%
  filter(market_type=="Wholesale")%>%
 dplyr::select(country,years,contains("2"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)


#second season (retail)
retail2=season_country%>%
  filter(market_type=="Retail"&n.yrs2>0)%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)%>%
 rbind(sum_retail2)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))



#second season (wholesale)
wholesale2=season_country%>%
  filter(market_type=="Wholesale"&n.yrs2>0)%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)%>%
 rbind(sum_wholesale2)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))


# header<-c("Country","Years","Markets","Market-Years",
#                 "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns",
#                 "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns")

# print=xtable(retail1,type="latex")
# names(print)<-header
# print(print,file=paste0("./retailprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)
# 
# print=xtable(retail2,type="latex")
# names(print)<-header
# print(print,file=paste0("./retailprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)
# 
# print=xtable(wholesale1,type="latex")
# names(print)<-header
# print(print,file=paste0("./wholesaleprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)
# 
# 
# print=xtable(wholesale2,type="latex")
# names(print)<-header
# print(print,file=paste0("./wholesaleprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)



###go with conservative calculations
header<-c("Country","Years","Markets","Market-Years",
                "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns")

retail1_c=retail1%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,contains("_c"))

print=xtable(retail1_c,type="latex")
names(print)<-header
print(print,file=paste0("./retailprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

retail2_c=retail2%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,contains("_c"))

print=xtable(retail2_c,type="latex")
names(print)<-header
print(print,file=paste0("./retailprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

wholesale1_c=wholesale1%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,contains("_c"))

print=xtable(wholesale1_c,type="latex")
names(print)<-header
print(print,file=paste0("./wholesaleprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)



rm(list=ls(pattern="sum_"),retail1,retail2,wholesale1,wholesale2,print,header,retail1_c,retail2_c,wholesale1_c)



```


8. Output figure for paper2/3: Dot plot of frequency of negative returns vs severity of trend (average returns)
```{r output8,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

cb1=season_mkt%>%
  filter(market_type=="Retail"&is.finite(e.returns1_c))


cb1plot=ggplot()+
   geom_point(data=cb1,aes(x=pct_season1_c*100,y=e.returns1_c*100,size=n.yrs1))+ scale_y_continuous(name="Average returns to storage (%)",limits=c(-50,150),breaks=seq(-50,150,50),expand=c(0,0)) +  scale_x_continuous(name="% of seasons with negative returns",limits=c(0,100),breaks=seq(0,100,20)) + 
   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_line(color="lightgray"),legend.position = c(1, 1),legend.justification = c(1, 1),
         axis.line = element_line(color="black"))+guides(size = guide_legend(reverse = TRUE))+
  geom_hline(yintercept=0,color="darkgray")+ scale_size(range = c(0.5,3),breaks=c(2,4,8,12,16,20),name="Number of \n market-years")

print(cb1plot)

ggsave("seasondotplot.png")

 
neg_all=cb1%>%filter(pct_season1==1) #22
pos_all=cb1%>%filter(pct_season1==0) #168
neg_country=unique(neg_all$country) #12 different countries
pos_country=unique(pos_all$country) #87 different countries
neg_market=unique(neg_all$market) #22 different markets
pos_market=unique(pos_all$market) #168 different markets
neg_all=season%>%filter(market%in%neg_market)#63 total observations for those 22 markets
pos_all=season%>%filter(market%in%pos_market)#909 total observations for those 168 markets

neg_year=unique(neg_all$cropyear) #15 different years
pos_year=unique(pos_all$cropyear) #19 different years



rm(cb1,cb1plot,list=ls(pattern="neg_")) 
rm(list=ls(pattern="pos_"))

```


9. Output figure for paper1/2/3: Boxplot of frequency of negative returns over time 
```{r output9,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")


dot= ggplot()+geom_jitter(data=subset(season,market_type=="Retail"),aes(x=factor(cropyear),y=returns1_c*100,color=yield_kgha),size=1.0,alpha=0.75)+ #geom_hline(yintercept=0,color="red",position="identity")+
  scale_color_gradient2(low="gray80",high="gray10",na.value="gray",name="Yield (kg/ha)",limits=c(0,6000))+
#scale_color_gradient2(low="chartreuse",high="darkgreen",na.value="gray",name="Yield (kg/ha)",limits=c(0,4000))+
  scale_y_continuous(name="Returns to storage (%)",limits=c(-100,500),breaks=seq(-100,500,100),expand=c(0,0))+
  scale_x_discrete(name="Year",breaks=c("2000","2004","2008","2012","2016","2020"),labels=c("2000","2004","2008","2012","2016","2020"),expand=c(0,0))+
  geom_hline(yintercept=0,color="red",position="identity")+
  theme(panel.grid.major = element_line(color="lightgray"),panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"),legend.position = c(1, 1),legend.justification = c(1, 1))
  #geom_jitter(data=subset(time,dpct<=0),aes(x=year, y=dpct,color="red",size=yield_kgha),alpha=0.5)+
 #geom_jitter(data=subset(time,dpct>0),aes(x=year,y=dpct,color="black",size=yield_kgha),alpha=0.5)+
#scale_color_manual(values=c("black","red")) + 
#scale_y_continuous(name="Seasonal Returns (%)",limits=c(-100,500),breaks=seq(-100,500,100))+
  # geom_text(data=time,aes(x=2010,y=450,label="High Planting Price, Low Harvest Price",color="black"),size=4)+
   # geom_text(data=time,aes(x=2010,y=-95,label="High Harvest Price, Low Planting Price",color="red"),size=4)
print(dot)
ggsave("cropyear_returns_dot.PNG")


box= ggplot()+geom_boxplot(data=subset(season,market_type=="Retail"),aes(x=factor(cropyear),y=returns1_c*100),outlier.shape=1,position="dodge") + geom_hline(yintercept=0,color="red",position="identity")+
 scale_y_continuous(name="Returns to storage (%)", limits=c(-100,500),breaks=seq(-100,500,100))+ scale_x_discrete(name="Year",breaks=c("2000","2004","2008","2012","2016","2020"))+
    theme(panel.grid.major = element_blank(),legend.position="none",panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"))

print(box)
ggsave("cropyear_returns_box.PNG")

rm(dot,box)


```



10. Plots for distribution of extreme harvest prices and returns (for seasonal returns for primary season)
```{r output10,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

extreme1=season%>%
  filter(market_type=="Retail"&is.finite(returns1_c))%>%
  group_by(country)%>%
  dplyr::mutate(z_h1=scale(hmin1),h1_d=as.factor(paste0("d",ntile(hmin1,10))))%>%
  ungroup()

decile=c("d1","d2","d3","d4","d5","d6","d7","d8","d9","d10")
extreme1$h1_d<-reorder.factor(extreme1$h1_d,new.order=decile)

extremedot=ggplot()+geom_point(data=extreme1,aes(x=z_h1,y=returns1_c*100,shape=factor(noarb1_c)))+
  scale_y_continuous(name="Returns to storage for primary maize season (%)",limits=c(-100,500),breaks=seq(-100,500,100)) + 
  scale_x_continuous(name="Z-score of harvest price for primary maize season",limits=c(-3,8),breaks=seq(-3,8,1),expand=c(0,0))+
  scale_shape_manual(values=c(3,1),breaks=c("0","1"),labels=c("Positive Returns","Negative Returns"),name="Returns to Storage")+
  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"),
        legend.position = c(0.9, 0.9),legend.justification = c(1, 1))

print(extremedot)
ggsave("harvestprices_returns.png")

rm(decile,extremedot)

```



11. OLS and probit regressions on harvest price (for primary maize retail season)
```{r OLSreg11 ,echo=FALSE}


split.df=split(extreme1,extreme1$country)
country.name=names(split.df)
#results<-list()
table=data.frame(country=as.character())

for (i in 1:length(country.name)){
df=split.df[[i]]
cname=country.name[[i]]

#OLS regression
o=lm(returns1_c*100~z_h1+factor(cropyear),data=df)
s=summary(o)
coef_o=s$coefficients[1,1]
pval_o=s$coefficients[1,4]
rsq_o=s$r.squared

#probit regression
p=glm(factor(noarb1)~z_h1+factor(cropyear),data=df,family=binomial(link = "probit"))
pm=probitmfx(factor(noarb1)~z_h1+factor(cropyear),data=df,atmean=FALSE,robust=TRUE)
rsq_p=PseudoR2(p,which="McFadden")
coef_p=pm$mfxest[1,1]
pval_p=pm$mfxest[1,4]

cprep=data.frame(cname,coef_o,pval_o,rsq_o,coef_p,pval_p,rsq_p)
table=rbind(table,cprep)

}

###pooled regressions
o_pool=lm(returns1_c*100~z_h1+factor(cropyear)+factor(country),data=extreme1)
s_pool=summary(o_pool)
rsq_o_pool=s_pool$r.squared
p_pool=glm(factor(noarb1)~z_h1+factor(cropyear)+factor(country),data=extreme1,family=binomial(link = "probit"))
rsq_p_pool=PseudoR2(p_pool,which="McFadden")


table=table%>%
  add_row(cname="CC Average",rsq_o=mean(table$rsq_o),rsq_p=mean(table$rsq_p))%>%
   add_row(cname="Pooled",rsq_o=rsq_o_pool,rsq_p=rsq_p_pool)%>%
  mutate(stars_o=ifelse(pval_o < .01, "***", ifelse(pval_o < .05, "** ", ifelse(pval_o < .1, "* ", " "))),
         stars_p=ifelse(pval_p < .01, "***", ifelse(pval_p < .05, "** ", ifelse(pval_p < .1, "* ", " "))))%>%
  dplyr::mutate(cp_o=paste(round(coef_o,3),stars_o,sep=""),cp_p=paste(round(coef_p,3),stars_p,sep=""),
         across(starts_with("rsq"),round,2))%>%
  dplyr::select(cname,cp_o,rsq_o,cp_p,rsq_p)



t=xtable(table,type="latex",auto=TRUE)
names(t)<-c("Country","Harvest price z-score (OLS)","R squared","Harvest price z-score (probit)","Pseudo-R squared")
print(t,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/OLSprobitreturns_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


rm(cmat,cprep,df,m,prep,results,table,split.df,c,cstars,n,names,o,table,t,r,v,p,i,coef,cname,pm,s,list=ls(pattern="pool"))
rm(list=ls(pattern="_o"))
rm(list=ls(pattern="_p"))


```


12.Analysis and output for paper v3: Risk premium/certainty equivalent over seasonal returns
```{r risk12, echo=FALSE}


#create data frame with prices and returns for primary maize retail season, then calculate mean and variance for prices and returns and the minimum risk coefficient to avoid storage for that harvest price
ex_price=season%>%
  filter(market_type=="Retail"& !is.na(returns1_c))%>%
  mutate(return=returns1_c,pl=pmax1,ph=hmin1)%>%
  arrange(country)%>%
  group_by(country)%>%
  dplyr::mutate(across(c(ph,pl,return),list(e=mean,v=var),na.rm=TRUE,.names = "{.fn}.{.col}"))%>%
  ungroup()%>%
  dplyr::select(1:5,e.pl,ph,v.pl,return,e.return,v.return)%>%
  mutate(minr.nostore=2*(e.pl/v.pl)*(e.pl-ph))


#create sequence of risk aversion coefficients between 0 and 5 
rr=seq(0,5,by=0.1)

#create certainty equivalent based on risk aversion coefficients and evaluate storage choice by comparing CE to harvest price and group by risk aversion tolerance with and without credit access (5% interest), also calculate the minimum risk coefficient to opt out of storage
sim=expand_grid(ex_price,rr)%>%
  mutate(ce=e.pl-((rr*v.pl)/(2*e.pl)))%>%
  mutate(nostore.0=if_else(ph>ce,1,0),nostore.5=if_else(ph>(ce/(1+.05)),1,0))%>%
  dplyr::mutate(bin=cut(rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))

#calculate market averages for storage avoidance by risk coefficient
sim_mkt=sim%>%
   group_by(country,market,rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

#calculate market averages for minimum risk coefficient to avoid storage
minr_mkt=ex_price%>%
   group_by(country,market)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

  
#calculate country averages over market averages for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country=sim_mkt%>%
   group_by(country,rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
  mutate(bin=cut(rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_mkt_c","nostore.5_mkt_c"))

#and for min risk coefficient
minr_country=minr_mkt%>%
   group_by(country)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()

#calculate country averages over all observations for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country_all=sim%>%
   group_by(country,rr)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
   ungroup()%>%
  mutate(bin=cut(rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_c","nostore.5_c"))


#and for min risk coefficient
minr_country_all=ex_price%>%
   group_by(country)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()

#calculate total rows and add to dataframes
sim_tot=sim_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country=rbind(sim_country,sim_tot)%>%
  dplyr::mutate(across(starts_with("nostore"),~paste0(sprintf("%.1f",.*100),"%")))

sim_tot_all=sim_country_all%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country_all=rbind(sim_country_all,sim_tot_all)%>%
  dplyr::mutate(across(starts_with("nostore"),~paste0(sprintf("%.1f",.*100),"%")))

minr_tot=minr_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())

minr_country=rbind(minr_country,minr_tot)%>%
  dplyr::mutate(across(where(is.numeric),round,2))

minr_tot_all=minr_country_all%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())

minr_country_all=rbind(minr_country_all,minr_tot_all)%>%
 dplyr::mutate(across(where(is.numeric),round,2))


#separate the data frames by analysis
#storage uptake percent by risk tolerance group (no credit/interest rate)
nostore_0=sim_country_all%>%
  dplyr::select(country,starts_with("nostore.0"))

#storage uptake percent by risk tolerance group (5% interest rate)
nostore_5=sim_country_all%>%
  dplyr::select(country,starts_with("nostore.5"))

minr_nostore=minr_country_all%>%
  dplyr::select(country,starts_with("minr."))


setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

table_grp=xtable(nostore_0,auto=TRUE,type="latex")
print(table_grp,file=paste0("./nostore_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

table_grp=xtable(nostore_5,auto=TRUE,type="latex")
print(table_grp,file=paste0("./nostore_i_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

table_grp=xtable(minr_nostore,auto=TRUE,type="latex")
print(table_grp,file=paste0("./nostore_minr_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


# risk_facet_pct=ggplot()+
#   geom_bar(data=sim_country_all,aes(x=rr,y=nostore_mkt_c),stat="identity",color="gray")+
#  #scale_fill_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   #scale_color_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_y_continuous(name="Storage Avoidance (%)",limits=c(0,100),breaks=seq(0,100,25),expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,5),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_y",ncol=4)+labs(title="Storage Avoidance by Risk Aversion Coefficient")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"),
#          legend.position = c(0.9, 0),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/riskcoef_facet.PNG",width=12,height=9)

# risk_malawi_pct=ggplot()+
#   geom_bar(data=subset(sim_country,country=="Malawi"),aes(x=rr,y=nostore_mkt_c,fill=bin),stat="identity")+
#  #scale_fill_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_fill_manual(values=c("blue","gray","red"),breaks=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)"),labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)"),name="Risk Tolerance",na.translate=FALSE)+
#   scale_y_continuous(name="Storage Avoidance (%)",limits=c(0,100),breaks=seq(0,100,25),expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,5),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_y",ncol=4)+labs(title="Storage Avoidance by Risk Aversion Coefficient")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"),
#          legend.position = c(0.75, 0.75),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/riskcoef_malawi.PNG",width=12,height=9)


rm(e_price,table_grp,nostore_0,nostore_5,list=ls(pattern="sim"))
rm(list=ls(pattern="minr"))


```


15. Predicted lean season price and certainty equivalent/risk aversion
```{r sdresults='asis', message = FALSE,include=FALSE}


split.df=split(extreme1,extreme1$country)
country.name=names(split.df)
#results<-list()
table3=data.frame(country=as.character(),coef=as.numeric())

for (i in 1:length(country.name)){
df=split.df[[i]]
cname=country.name[[i]]
m=lm(pmax1~factor(cropyear)+hmin1,data=df)
#s=summary(m)
#coef=s$coefficients[,1]
#cprep=data.frame(cname,coef)
#table3=rbind(table3,cprep)
p_df=df%>%
  dplyr::select(country,market,cropyear,hmin1)

p_df$p_pl=predict(m,newdata=p_df)

table3=rbind(table3,p_df)

}


######Returns by country (dotplot) vs prediction



#returns to main season
p_risk1=table3%>%
  dplyr::rename(ph=hmin1)

ex_price=p_risk1%>%
  arrange(country)%>%
  group_by(country)%>%
  dplyr::mutate_at("p_pl",funs(e.pl=mean,v.pl=var))%>%
  ungroup()

#create sequence of risk aversion coefficients 
rr=seq(0,5,by=0.1)

#create certainty equivalent by risk aversion coefficient and evaluate storage choice
sim=expand_grid(ex_price,rr)%>%
  mutate(ce=e.pl-((rr*v.pl)/(2*e.pl)))%>%
  mutate(nostore.0=if_else(ph>ce,1,0))%>%
  dplyr::mutate(bin=cut(rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))

#market averages by risk coefficient
sim_mkt=sim%>%
   group_by(country,market,rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

#country averages over market averages by risk coefficient
sim_country=sim_mkt%>%
   group_by(country,rr)%>%
 dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
   dplyr::mutate(bin=cut(rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_mkt_c"))%>%
  dplyr::select(1:4)

#country averages over all observations by risk coefficient
sim_country_all=sim%>%
   group_by(country,rr)%>%
 dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
   dplyr::mutate(bin=cut(rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_c"))%>%
  dplyr::select(1:4)

#calculate total rows and add to dataframes
sim_tot=sim_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country=rbind(sim_country,sim_tot)%>%
  dplyr::mutate(across(where(is.numeric),~paste0(sprintf("%.1f",.*100),"%")))

sim_tot_all=sim_country_all%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country_all=rbind(sim_country_all,sim_tot_all)%>%
  dplyr::mutate(across(where(is.numeric),~paste0(sprintf("%.1f",.*100),"%")))


table_grp=xtable(sim_country_all,auto=TRUE,type="latex")
print(table_grp,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/nostore_pred",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


# risk_facet_pct=ggplot()+
#   geom_bar(data=sim_country,aes(x=rr,y=nostore_mkt_c),stat="identity",color="gray")+
#  #scale_fill_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   #scale_color_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_y_continuous(name="Storage Avoidance (%)",limits=c(0,100),breaks=seq(0,100,25),expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,5),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_y",ncol=4)+labs(title="Storage Avoidance by Risk Aversion Coefficient")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"),
#          legend.position = c(0.9, 0),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/riskcoef_facet.PNG",width=12,height=9)


rm(ex_price,m,p_df,p_risk1,table_grp,table3,i,rr,cname,country.name,split.df,nostore_0,df,extreme1)
rm(list=ls(pattern="sim"))


```



Appendix

A1.Box and dotplots for intratemporal returns
```{r durationA1,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")


######Returns to duration by country (dotplot)
f_grid_dur_dot=ggplot()+geom_jitter(data=subset(duration1,is.finite(returns1)&market_type=="Retail"),aes(x=factor(duration1),y=returns1*100,color=factor(noarb1)),size=1)+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+
  scale_color_manual(name="Returns",breaks=c("0","1"),values=c("red","black"),labels=c("Negative Returns","Positive Returns"))+
  facet_wrap(.~country,ncol=4,scale="free_x")+labs(title="Intratemporal returns to storage")+theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

#print(f_grid_dur_dot)
ggsave("dur_returns_facet_dot.PNG",width=12,height=9)

######Returns to duration by country (boxplot)
f_grid_dur_box=ggplot()+geom_boxplot(data=subset(duration1,is.finite(returns1)&market_type=="Retail"),aes(x=factor(duration1),y=returns1*100),outlier.shape=1,position="dodge")+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+geom_hline(yintercept=0,color="red",position="identity")+
  facet_wrap(.~country,ncol=4)+
  #labs(title="Intratemporal returns to storage (primary maize season)")+
  theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

print(f_grid_dur_box)
ggsave("dur_returns_facet_box.PNG",width=12,height=9)

rm(f_grid_dur_dot,f_frid_dur_box)

```



9.z Zambia Maize Retail Price Trend Tables
```{r table1,echo=FALSE, warning=FALSE,paged.print=TRUE,eval=TRUE}

#setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Tables")
zambia_mkt=season_month%>%
  filter(country=="Zambia"&year>=2015)%>%
   group_by(country,region,market)%>%
   dplyr::summarise(n_mktyr=n(),n_neg=sum(noarb12),
      pct_m=mean(pct_arb12),pct_pos=mean(pct_arb12[pct_arb12>0]),pct_neg=mean(pct_arb12[pct_arb12<=0]))%>%
  ungroup()%>%
   mutate(pct_yr=n_neg/n_mktyr)%>%
  dplyr::select(country,region,market,n_mktyr,pct_yr,pct_m,pct_pos,pct_neg)%>%
   dplyr::mutate(across(starts_with("pct"),~if_else(is.nan(.)," ",paste0(sprintf("%.1f",.*100),"%"))))


z_years=season_month%>%
  filter(country=="Zambia"&year>=2015&noarb1==1)%>%
  group_by(country,region,market)%>%
  dplyr::summarise(negyrs=paste(year,collapse=','))

zambia_mkt=left_join(zambia_mkt,z_years,by=c("country","region","market"))%>%
  dplyr::select(2:4,5,9,6:8)

print=xtable(zambia_mkt,type="latex")
names(print)<-c("Region","Market","Market-Years","Frequency of Negative Returns","Years with Negative Returns",
                "Average Total Returns","Average Positive Returns","Average Negative Returns")
print(print,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Tables/zambia_mkts",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


```


Kenya sidenote
```{r Kenya,echo=FALSE,include=FALSE}

kenya_0114=kenya%>%
  filter(year==2014&month==1)%>%
  mutate(price_jan14=price_kg)%>%
  dplyr::select(country,region,market,commodity,price_jan14)

kenya_01=kenya%>%
  filter(month==1)%>%
  mutate(price_jan=price_kg)%>%
  dplyr::select(country,region,market,commodity,year,price_jan)

kenya=kenya%>%
  left_join(cpi,by=c("country","year","month"))%>%
  mutate(price_real=price_kg*100/cpi,)%>%
  dplyr::select(-cpi)%>%
  left_join(kenya_01,by=c("country","region","market","commodity","year"))%>%
  mutate(price_jan=price_kg/price_jan)%>%
  left_join(kenya_0114,by=c("country","region","market","commodity"))%>%
 mutate(price_jan14=price_kg/price_jan14,commodity=str_replace(commodity, "^[^_]*-", ""))

rm(kenya_01,kenya_0114)

kenya_markets=kenya%>%
  group_by(commodity,market)%>%
  dplyr::summarise(n=n())%>%
 pivot_wider(names_from=commodity,values_from=n)%>%
  dplyr::rename(Retail=2,Wholesale=3)%>%
  add_row(market="Total",Retail=sum(.$Retail,na.rm=TRUE),Wholesale=sum(.$Wholesale,na.rm=TRUE))

print=xtable(kenya_markets,type="latex")
print(print,file="C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Tables/kenya_021021.tex",include.rownames=FALSE)

kenya_1418=kenya%>%
  filter(year%in%2014:2018)

kisumu_jan_free=ggplot()+
   geom_pointline(data=subset(kenya_1418,market=="Kisumu"),aes(x=month,y=price_jan),distance=NULL)+
  labs(x="Month",y="Price per KG (Normalized to January)") +
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
  facet_rep_wrap(.~year,ncol=3,scales="free",repeat.tick.labels = TRUE)+labs(title="Kisumu wholesale market (2014 - 2018) REPLICATE R2 FREE Y SCALE")+
theme(panel.grid.minor = element_blank(),panel.background = element_rect(fill="white"),panel.grid.major.y = element_line(color="lightblue"), panel.grid.major.x = element_blank(),axis.line = element_line(color="black"), strip.background = element_rect(fill="lightblue"),axis.text=element_text(size=12),axis.title=element_text(size=12),
        plot.title = element_text(hjust = 0.5,face="bold",size=12),
        panel.margin = unit(1,"line"),text= element_text(family="serif"))

ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/Kisumu_Jan1_free_yscale.PNG",width=12,height=9)

kisumu_jan_same=ggplot()+
   geom_pointline(data=subset(kenya_1418,market=="Kisumu"),aes(x=month,y=price_jan),distance=NULL)+
  labs(x="Month",y="Price per KG (Normalized to January)") +
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
  facet_rep_wrap(.~year,ncol=3,repeat.tick.labels = TRUE)+labs(title="Kisumu wholesale market (2014 - 2018) REPLICATE R2 SAME Y SCALE")+
theme(panel.grid.minor = element_blank(),panel.background = element_rect(fill="white"),panel.grid.major.y = element_line(color="lightblue"), panel.grid.major.x = element_blank(),axis.line = element_line(color="black"), strip.background = element_rect(fill="lightblue"),axis.text=element_text(size=12),axis.title=element_text(size=12),
        plot.title = element_text(hjust = 0.5,face="bold",size=12),
        panel.margin = unit(1,"line"),text= element_text(family="serif"))

ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/Kisumu_Jan1_same_yscale.PNG",width=12,height=9)


kisumu_jan14=ggplot()+
   geom_pointline(data=subset(kenya_1418,market=="Kisumu"),aes(x=month,y=price_jan14),distance=NULL)+
  labs(x="Month",y="Price per KG (Normalized to January 2014)") +
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
  facet_rep_wrap(.~year,ncol=3,repeat.tick.labels = TRUE)+labs(title="Kisumu wholesale market (2014 - 2018) NORMALIZED TO JAN 2014 SAME Y SCALE")+
theme(panel.grid.minor = element_blank(),panel.background = element_rect(fill="white"),panel.grid.major.y = element_line(color="lightblue"), panel.grid.major.x = element_blank(),axis.line = element_line(color="black"), strip.background = element_rect(fill="lightblue"),axis.text=element_text(size=12),axis.title=element_text(size=12),
        plot.title = element_text(hjust = 0.5,face="bold",size=12),
        panel.margin = unit(1,"line"),text= element_text(family="serif"))

ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/Kisumu_Jan114_same_yscale.PNG",width=12,height=9)

# kenya_prices_nakuru=ggplot()+
#    geom_pointline(data=subset(kenya,year%in%2014:2018&market=="Nakuru"),aes(x=month,y=price_real),distance=NULL)+
#   labs(x="Month",y="Price per KG (2015 Local Currency)") +ylim(10,50)+
#     scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
#   facet_rep_wrap(.~year,ncol=3,repeat.tick.labels = TRUE)+labs(title="Figure 2: Nakuru wholesale market (2014 - 2018)")+
# theme(panel.grid.minor = element_blank(),panel.background = element_rect(fill="white"),panel.grid.major.y = element_line(color="lightblue"), panel.grid.major.x = element_blank(),axis.line = element_line(color="black"), strip.background = element_rect(fill="lightblue"),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# 
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/Nakuru.PNG",width=12,height=9)



kenya_prices_all=ggplot()+
   geom_path(data=subset(kenya,year%in%2014:2018),aes(x=month,y=price_real,group=market,color=commodity,linetype=commodity))+
  labs(x="Month",y="Price per KG (2015 Local Currency)") +ylim(0,100)+
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
  facet_rep_wrap(.~year,ncol=3,repeat.tick.labels = TRUE)+labs(title="Figure 3: Kenya Retail and Wholesale Markets (2014 - 2018)")+
theme(panel.grid.minor = element_blank(),panel.background = element_rect(fill="white"),panel.grid.major = element_blank(),axis.line = element_line(color="black"), strip.background = element_rect(fill="lightblue"),
        plot.title = element_text(hjust = 0.5,face="bold"),legend.position = c(0.95, 0.25),legend.justification = c(1, 1),legend.text = element_text(size=15),legend.title = element_text(size=15),
        panel.margin = unit(1,"line"),text= element_text(family="serif"))+guides(color=guide_legend(title="Each line represents a market"),linetype=guide_legend(title="Each line represents a market"))

ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/kenya_marketprices.PNG",width=12,height=9)



```



A1. Probit regressions for decile and duration
```{r reg,echo=FALSE,include=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Tables")

coef_prep=function(x){
  cmat=as.matrix(x$mfxest)
  n<-row.names(cmat)
  c<-sprintf(cmat[,"dF/dx"],fmt='%#.2f')
  p<-cmat[,"P>|z|"]
  mystars <- ifelse(p < .01, "***", ifelse(p < .05, "** ", ifelse(p < .1, "* ", " ")))
  m=as.data.frame(matrix(c(n,paste(c, mystars, sep="")), ncol=2))
}


#####1. Regress probability of negative returns on harvest price, year, and country
#probit.1=probitmfx(noarb1~z_h1+factor(country)+factor(year)-1,data=reg_df)
#p1=glm(noarb1~0+factor(country)+factor(year)+z_h1,data=season_df,family=binomial(link = "probit"),x=TRUE)
#p1_out=coef_prep(summary(p1))
#colnames(p1_out)<-c("variable","est.probit")
#p1_ma=margins(p1)
#print(p1_ma$out)

#####3. Break harvest price into deciles by country and run probit for probability of negative returns on decile of harvest price, year, and country
#p3=glm(factor(noarb1)~factor(country)+factor(year)+factor(h1_d),data=season_df,family=binomial(link = "probit"))
p3_mx=probitmfx(factor(noarb1)~factor(h1_d)+factor(country)+factor(year),data=season_df,atmean=FALSE,robust=TRUE)
p3_mx_coef <- p3_mx$mfxest[,1] #Estimated coefficients
p3_mx_pz <- p3_mx$mfxest[,4] #pr>z
p3_out=coef_prep(p3_mx)
colnames(p3_out)<-c("variable","est.meffects.alldeciles")

# p33_mx=probitmfx(factor(noarb12)~factor(h1_d)+factor(country)+factor(year),data=season_df,atmean=FALSE,robust=TRUE)
# p33_mx_coef <- p33_mx$mfxest[,1] #Estimated coefficients
# p33_mx_pz <- p33_mx$mfxest[,4] #pr>z
# p33_out=coef_prep(p33_mx)
# colnames(p33_out)<-c("variable","est.meffects.alldeciles")
#p3_ma=margins(p3)
#print(p3_ma$out)

#####4. Break harvest price into deciles by country and run probit for probability of negative returns on year, and country and duration
#p4=glm(noarb1~factor(country)+factor(year)+factor(duration1)+factor(h1_d),data=duration_month,family=binomial(link = "probit"))
p4_mx=probitmfx(factor(noarb1)~z_h1+factor(duration1)+factor(country)+factor(year),data=duration_month,atmean=FALSE)
p4_out=coef_prep(p4_mx)
colnames(p4_out)<-c("variable","est.meffects.duration")
#p4_ma=margins(p4)
#print(p4_ma$out)


#####2. Break harvest price into quintile by country and run probit for each quintile for probability of negative returns on duration, year, and country
split.df=split(duration_month,duration_month$h1_q)
quintile.name=names(split.df)

for (i in 1:length(quintile.name)) {
df=split.df[[i]]

#out=summary(glm(factor(noarb1)~factor(country)+factor(year)+z_h1,data=df,family=binomial(link = "probit")))
out=probitmfx(factor(noarb1)~factor(duration1)+factor(country)+factor(year),data=df,atmean=FALSE)
m=coef_prep(out)
# cmat=as.matrix(out$coefficients)
# n<-row.names(cmat)
# c<-sprintf(cmat[,"Estimate"],fmt='%#.2f')
# p<-cmat[,"Pr(>|z|)"]
# mystars <- ifelse(p < .01, "***", ifelse(p < .05, "** ", ifelse(p < .1, "* ", " ")))
# m=as.data.frame(matrix(c(n,paste(c, mystars, sep="")), ncol=2))
colnames(m)<-c("variable",paste0("est.meffect.duration.",quintile.name[i]))
assign(paste0("cp.",quintile.name[i]),m)

}

table1<-full_join(p3_out,p4_out,by=c("variable"))%>%
  full_join(cp.q1,by=c("variable"))%>%
  full_join(cp.q2,by=c("variable"))%>%
  full_join(cp.q3,by=c("variable"))%>%
  full_join(cp.q4,by=c("variable"))%>%
  full_join(cp.q5,by=c("variable"))%>%
  mutate(variable=str_replace(variable, "factor\\(.*\\)", ""))


t=xtable(table1,type="latex",auto=TRUE)
#names(t)<-c("Variable","Negative Returns ",q1,q2,q3,q4,q5)
align(t)<-"l|l|r|r|rrrrr|"
print(t,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Tables/probitreturns_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


# table2<-full_join(p3_out,p4_out,by=c("variable"))%>%
#   mutate(variable=str_replace(variable, "factor\\(.*\\)", ""))
# 
# t2=xtable(table2,type="latex",auto=TRUE)
# #names(t)<-c("Variable","Negative Returns ",q1,q2,q3,q4,q5)
# align(t2)<-"l|l|r|r|"
# 
# 
# print(t2,file="Returns_112420.tex",include.rownames=FALSE)

#p5_mx=probitmfx(factor(noarb1)~+factor(country)+factor(year),data=df,atmean=FALSE)
# c.logit=exp(coef(logit))
# se.coef <- function(glm.output){sqrt(diag(vcov(glm.output)))}
# se.logit<- c.logit * se.coef(logit)
# z <- coef(logit)/se.coef(logit)
# p <- 2*pnorm(abs(coef(logit)/se.coef(logit)), lower.tail = F)
# #p<-cmat[,"Pr(>|t|)"]
# mystars <- ifelse(p < .01, "***", ifelse(p < .05, "** ", ifelse(p < .1, "* ", " ")))
# estimate.logit=paste(sprintf(c.logit,fmt='%#.2f'), mystars, sep="")
# m.logit=as.data.frame(estimate.logit)

######Returns to duration by country (dotplot) vs prediction
p1=lm(pct_arb1~0+factor(h1_d)+factor(duration1)+factor(country)+factor(year),data=duration_month)
summary(p1)

h1_d=paste0("d",seq(1,10,by=1))
duration1=seq(1,11,by=1)
country=unique(duration_month$country)
year=seq(2000,2019,by=1)

p_df=expand_grid(h1_d,duration1,country,year)
p_df$pct_arb1_p=predict(p1,newdata=p_df)

#p_df=p_df%>%
 # filter(is.finite(pct_arb1))

duration_returns=duration_month%>%
  dplyr::select(country,market,year,h1_d,duration1,pct_arb1)%>%
  dplyr::rename(pct_arb1_a=pct_arb1)%>%
  left_join(p_df,by=c("country","year","h1_d","duration1"))%>%
pivot_longer(cols=starts_with("pct_arb"),names_to="type",values_to="pct_returns",values_drop_na = TRUE)%>%
  mutate(type=as.factor(type))

predict_dur=ggplot()+
  geom_jitter(data=duration_returns,aes(x=factor(duration1),y=pct_returns*100,color=type),size=1,alpha=0.5)+
scale_y_continuous(name="Percent returns to harvest price (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+
  scale_color_manual(name="Returns",breaks=c("pct_arb1_a","pct_arb1_p"),values=c("blue","green"),labels=c("Actual Returns","Predicted Returns"))+
  #scale_shape_manual(name="Returns",breaks=c("pct_arb1_a","pct_arb1_p"),values=c("16","17"),labels=c("Actual Returns","Predicted Returns"))+
  geom_hline(yintercept=0,color="red",position="identity")+
  facet_wrap(.~country,ncol=4)+labs(title="Returns by Number of Months Post-Harvest")+theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"),legend.title = element_blank())

#print(f_grid_dur_dot)
ggsave("predict_dur_facet.PNG",width=16,height=9)



######Returns by country (dotplot) vs prediction
p11=lm(pct_arb1~0+factor(h1_d)+factor(country)+factor(year),data=season_month)
summary(p11)

h1_d=paste0("d",seq(1,10,by=1))
country=unique(season_month$country)
year=seq(2000,2019,by=1)

p_df2=expand_grid(h1_d,country,year)
p_df2$pct_arb1_p=predict(p11,newdata=p_df2)

decile_returns=season_month%>%
  dplyr::select(country,year,h1_d,pct_arb1)%>%
dplyr::rename(pct_arb1_a=pct_arb1)%>%
  left_join(p_df2,by=c("country","year","h1_d"))%>%
pivot_longer(cols=starts_with("pct_arb"),names_to="type",values_to="pct_returns",values_drop_na = TRUE)%>%
  mutate(type=as.factor(type))

decile_returns$h1_d<-reorder.factor(decile_returns$h1_d,new.order=decile)

predict_hdec=ggplot()+geom_jitter(data=decile_returns,aes(x=factor(h1_d),y=pct_returns*100,color=type),size=1,alpha=0.5)+
 scale_y_continuous(name="Percent returns to harvest price (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Harvest Price decile")+
  geom_hline(yintercept=0,color="red",position="identity")+
  scale_color_manual(name="Returns",breaks=c("pct_arb1_a","pct_arb1_p"),values=c("blue","green"),labels=c("Actual Returns","Predicted Returns"))+
  facet_wrap(.~country,ncol=4)+labs(title="Seasonal Returns by Harvest Price Decile")+theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"),legend.title = element_blank())

#print(f_grid_dur_dot)
ggsave("predict_dec_facet.PNG",width=16,height=9)

rm(list=ls(pattern="q"),decile,h1_d,i,year,country,decile_returns,df,out,m,t,t1,t2,table1,table2)
rm(list=ls(pattern="p"))

```



A2. Plots for distribution of extreme harvest prices and returns (for full set of duration)
```{r plotsH,echo=FALSE,include=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

# ######Returns to harvest price by country
# f_grid_hprice=ggplot()+geom_jitter(data=season_month,aes(x=hend_price1,y=pct_arb12*100,color=factor(noarb12)))+ ylab("Seasonal Returns (%)")+xlab("Harvest Price (2015 local currency)")+scale_color_manual(name="Seasonal Returns",breaks=c("1","0"),values=c("red","black"),labels=c("Negative Returns","Positive Returns"))+facet_wrap(.~country,scales="free_x",ncol=4)+labs(title="Returns to storage by harvest price")+theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))
# 
# #print(f_grid_hprice)
# ggsave("hprice_returns_facet.PNG",width=12,height=9)

######Returns to duration by country (dotplot)
f_grid_dur_dot=ggplot()+geom_jitter(data=subset(duration1,is.finite(returns1)&market_type=="Retail"),aes(x=factor(duration1),y=returns1*100,color=factor(noarb1)),size=1)+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+
  scale_color_manual(name="Returns",breaks=c("0","1"),values=c("red","black"),labels=c("Negative Returns","Positive Returns"))+
  facet_wrap(.~country,ncol=4,scale="free_x")+labs(title="Intratemporal returns to storage")+theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

#print(f_grid_dur_dot)
ggsave("dur_returns_facet_dot.PNG",width=12,height=9)

######Returns to duration by country (boxplot)
f_grid_dur_box=ggplot()+geom_boxplot(data=subset(duration1,is.finite(returns1)&market_type=="Retail"),aes(x=factor(duration1),y=returns1*100),outlier.shape=1,position="dodge")+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+geom_hline(yintercept=0,color="red",position="identity")+
  facet_wrap(.~country,ncol=4)+
  #labs(title="Intratemporal returns to storage (primary maize season)")+
  theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

print(f_grid_dur_box)
ggsave("dur_returns_facet_box.PNG",width=12,height=9)



# #boxplot for distribution of returns over the whole set for season 1 by duration post-harvest
# returns_box= ggplot(data=duration_month,aes(x=factor(duration1),y=pct_arb1*100))+geom_boxplot(outlier.shape=1,position="dodge")+geom_hline(yintercept=0,color="red",position="identity")+
#  scale_y_continuous(name="Returns to storage (%)", limits=c(-100,500),breaks=seq(-100,500,100))+ scale_x_discrete(name="Number of months post-harvest", breaks=c("1","2","3","4","5","6","7","8","9","10","11"),labels=c("1","2","3","4","5","6","7","8","9","10","11"))+ 
#     theme(panel.grid.major = element_blank(),legend.position="none",panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"))

#print(returns_box)
#ggsave("returns_duration_box.PNG",width=12,height=9)

# #distribution of harvest price zscores by country including Guinea
# hm1=ggplot()+geom_boxplot(data=hend_month1,aes(x=factor(country),y=z_h1),outlier.shape=1,position="dodge")+
#  scale_y_continuous(name="Harvest Price z-score (w.r.t. country mean)", limits=c(-5,10),breaks=seq(-5,10,1),expand=c(0,0))+xlab("Country")+ggtitle("Distribution of Harvest Prices by Country (including Guinea)")
# 
# #print(hm1)
# ggsave("harvestprices_zcountry_box.PNG")
# 
# #distribution of harvest price zscores by country without Guinea
# # hm1_ng=ggplot()+geom_boxplot(data=subset(hend_month1,!country%in% c("Guinea","Nigeria","Mauritania")),aes(x=factor(country),y=z_h1),outlier.shape=1,position="dodge")+
# #  scale_y_continuous(name="Harvest Price z-score (w.r.t. market mean)", limits=c(-1,5),breaks=seq(-1,5,1),expand=c(0,0))+xlab("Country")+ggtitle("Distribution of Harvest Prices by Country (without Guinea)")+geom_text(data=subset(nobs,country!="Guinea"),aes(x=country,y=-0.9,label=n),size=3,color="red")
# # 
# # #print(hm1)
# # ggsave("harvestprices_noGuinea_box.PNG")
# 
# #distribution of harvest price zscores by country without Guinea, and with returns by duration
# hm_arb1_ng=ggplot()+geom_boxplot(data=subset(hend_month1,!country%in% c("Guinea","Nigeria","Mauritania","Guinea-Bissau")),aes(x=factor(country),y=z_h1),outlier.shape=4,position="identity",size=1.5)+
#   geom_jitter(data=subset(duration_mkt,country!="Guinea"&duration1>0),aes(x=factor(country),y=pct_arb1_m/100,color=duration1),alpha=0.5,size=1.5)+
#   scale_color_gradient(low="lightgreen",high="black",name="Number of months \n post-harvest",limits=c(1,12),labels=seq(0,12,3),breaks=seq(0,12,3))+
#   scale_y_continuous(name="Harvest Price z-score (w.r.t. market mean)", limits=c(-1,5),breaks=seq(-1,5,1),expand=c(0,0),sec.axis=sec_axis(~.*100,name="Average returns to storage by market and duration (%)"))+xlab("Country")+labs(title="Distribution of Harvest Prices by Country",subtitle="Boxplots of Harvest Price z-scores w.r.t market mean \n Points of Average Market Returns by Months Post-Harvest")+
#   theme(legend.position=c(0.5,0.9),panel.background = element_blank(),axis.line = element_line(color="black"),legend.background = element_rect(size=0.5, linetype="solid",color="gray"),plot.title = element_text(hjust = 0.1,face="bold"),plot.subtitle = element_text(hjust = 0.1))
# 
# #print(hm1_ng)
# ggsave("harvestprices_returns_noG.PNG")


#distribution of harvest price zscores by country without Guinea, and with returns by duration
# hd_arb1_ng=ggplot()+geom_jitter(data=duration_month,aes(y=pct_arb1,x=h1_,color=duration1))
#   
#   geom_jitter(data=subset(duration_mkt,country!="Guinea"&duration1>0),aes(x=factor(country),y=pct_arb1_m/100,color=duration1),alpha=0.5,size=1.5)+
#   scale_color_gradient(low="lightgreen",high="black",name="Number of months \n post-harvest",limits=c(1,12),labels=seq(0,12,3),breaks=seq(0,12,3))+
#   scale_y_continuous(name="Harvest Price z-score (w.r.t. market mean)", limits=c(-1,5),breaks=seq(-1,5,1),expand=c(0,0),sec.axis=sec_axis(~.*100,name="Average returns to storage by market and duration (%)"))+xlab("Country")+labs(title="Distribution of Harvest Prices by Country",subtitle="Boxplots of Harvest Price z-scores w.r.t market mean \n Points of Average Market Returns by Months Post-Harvest")+
#   theme(legend.position=c(0.5,0.9),panel.background = element_blank(),axis.line = element_line(color="black"),legend.background = element_rect(size=0.5, linetype="solid",color="gray"),plot.title = element_text(hjust = 0.1,face="bold"),plot.subtitle = element_text(hjust = 0.1))
#print(hm1_ng)
#ggsave("harvestprices_returns_noG.PNG")



##########do dot plots for for each country, and add in second harvest for those countries?
# levels(mz1$zbin1)<-list("[-1,-0.5]"="[-1,-0.5]", "(-0.5,0]"="(-0.5,0]","(0,0.5]"="(0,0.5]", "(0.5,1]"="(0.5,1]", "(1,1.5]"="(1,1.5]", "(1.5,2]"="(1.5,2]", "(2,2.5]"="(2,2.5]", "(2.5,3]"="(2.5,3]", "(3,5.5)"="(5,5.5]","(3,5.5)"="(4.5,5]","(3,5.5)"="(4,4.5]","(3,5.5)"="(3.5,4]","(3,5.5)"="(3,3.5]")
# 
# 
# returns_dot=ggplot()+geom_point(data=mz1,aes(x=factor(duration1),y=pct_arb1,color=zbin1),size=2,alpha=0.75)+
#    scale_x_discrete(name="Number of months post-harvest", breaks=c("1","2","3","4","5","6","7","8","9","10","11"),labels=c("1","2","3","4","5","6","7","8","9","10","11"))+ 
#  scale_y_continuous(name="Percent returns to harvest price (%)", limits=c(-100,500),breaks=seq(-100,500,100))+
#   scale_color_manual(
#     #values= c("red4","red","lightgreen","green1","green2","green3","green4","forestgreen","darkgreen"),
#      values= c("red4","red","skyblue1","skyblue3","dodgerblue1","dodgerblue3","blue2","blue4","midnightblue"),
#     breaks=c("[-1,-0.5]", "(-0.5,0] ","(0,0.5] ","(0.5,1] ","(1,1.5] ","(1.5,2]", "(2,2.5] ","(2.5,3]", "(3,5.5)"),
#                      name="Z score of harvest price")

rm(hm1,hm1_ng,hm_arb1_ng,returns_box,list=ls(pattern="f_grid"))

```




A4. (tbd ) Analysis and output for paper 1.5: Risk premium/certainty equivalent over all length of time
```{r sd,echo=FALSE,results='asis', message = FALSE}

# setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R/output")
# #create sequence of storage losses from 0-100%
# #alpha_val=seq(0.00,0.75,by=0.01)
# 
# #alpha_results=data.frame(country=character(),equal_test=numeric(),e_store=numeric(),e_nostore=numeric(),
#    # FOSD=character(),p_d_within=numeric(),SOSD=character(),p_s_within=numeric(),TOSD=character(),p_t_within=numeric(),alpha=numeric())
# 
# 
# #for (a in alpha_val){
# 
# #returns to main season
# duration_risk1=duration_month%>%
#     #dplyr::select(country,market,year,month,date,price_real,yield_kgha,hend_price1,pct_arb1)%>%
#   filter(!is.na(yield_kgha)&year<2020&!is.na(pct_arb1))%>%
#   mutate(wealth0=hend_price1*yield_kgha,wealth1=price_real*yield_kgha,return=pct_arb1)%>%
#   dplyr::rename(pl=price_real,ph=hend_price1,yield=yield_kgha)%>%
#   dplyr::select(1:5,pl,ph,duration1,yield,wealth0,wealth1,return)
# 
# 
# #number of observations by market and duration, 8494 have 2 or more observations
# count_mktmonth=aggregate(data=duration_risk1,pl~country+market+duration1,FUN=length)%>%
#   arrange(country,market,duration1)%>%
#   group_by(country,market,duration1)%>%
#   filter(pl>1)
# 
# 
# d_ex_price=duration_risk1%>%
#   arrange(country)%>%
#   group_by(country,duration1)%>%
#   dplyr::mutate(across(c(ph,pl,return),list(e=mean,v=var),na.rm=TRUE,.names = "{.fn}.{.col}"))%>%
#   ungroup()%>%
#   dplyr::select(1:5,duration1,e.pl,ph,v.pl,return,e.return,v.return)
# 
# 
# #create sequence of risk aversion coefficients 
# rr=seq(0,6,by=0.1)
# 
# sim_rr=expand_grid(d_ex_price,rr)%>%
#   mutate(ce1=e.pl-((rr*v.pl)/(2*e.pl))
#          #,ce2=e.return*(1-((v.return*rr)/2)),r.rp=(v.return*rr)/2
#          )%>%
#   mutate(choice1=if_else(ph<ce1,"store","no storage"),store1=if_else(ph<ce1,1,0)
#          #,store2=if_else(r.rp<((e.pl/ph)-1),1,0)
#          )%>%
#    group_by(country,rr,duration1)%>%
#   dplyr::summarise(store1_m=mean(store1))%>%
#   mutate(store1_m=100*store1_m)
# 
# 
# risk_plot2=ggplot()+
#   geom_path(data=sim_rr,aes(x=rr,y=factor(duration1),color=store1_m,group=duration1),size=2)+
#   scale_color_gradient(low="yellow",high="red",name="Percent of Markets Storing",limits=c(0,100))+
#   scale_y_discrete(name="Number of Months Post-Harvest",expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,6),breaks=seq(0,6,1),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_x",ncol=4)+labs(title="Optimal Storage Uptake by Number of Months Post-Harvest")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"),
#          legend.position = c(0.9, 0),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         plot.margin=margin(-0.5,-0.5,-0.5,-0.5,"pt"), panel.margin = unit(0,"null"),
#         text= element_text(family="serif"))
# 
# 
# ggsave("riskcoef_dur_110420.PNG",width=12,height=9)


```


A5. Output for Hope presentation: Monthly Average and Min Max Graphs by Country and Market
```{r monthly average graphs, echo=FALSE, warning=FALSE,paged.print=TRUE,eval=TRUE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/Country level")

cclist=country

maize_monavg = duration_month%>%
  filter(country%in%cclist)%>%
  group_by(country,market,commodity,month) %>%
  dplyr::summarise(month_avg_real=mean(price_real,na.rm=TRUE))

maize_minmax=duration_month%>%   
  dplyr::group_by(country,market,commodity,year)%>%
  filter(!is.na(price_real))%>%
  dplyr::summarise(minprice=min(price_real),maxprice=max(price_real),minmonth=month[which.min(price_real)],maxmonth=month[which.max(price_real)],
                   minmonthtype=month_type1[which.min(price_real)],maxmonthtype=month_type1[which.max(price_real)])%>%
            mutate(diffpct_maxmin=(maxprice-minprice)/minprice)%>%
    dplyr::select(country,market,year,commodity,contains("price"),diffpct_maxmin,contains("month"))%>%
  melt(id=c("country","market","commodity","year"),measure.vars=c("minmonth","maxmonth"))%>%
 arrange(country,market,commodity,year)%>%
  #unite(country,commodity,col="country_commodity",sep="-",remove=FALSE)%>%
dplyr::rename(monthtype=variable,month=value) 

seasons2=seasons%>%
 mutate(country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))

monthly.graph = function(cclist,na.rm=TRUE) {

for (i in seq_along(cclist)){
 
s=subset(seasons2,seasons2$country==cclist[i])
m=subset(maize_monavg,maize_monavg$country==cclist[i])
mx=subset(maize_minmax,maize_minmax$country==cclist[i])

plot1=ggplot()+
       geom_rect(data=s,mapping=aes(xmin=main_plant_start,xmax=main_plant_end,ymin=-Inf,ymax=Inf,fill="gray90"),
                 color="black",alpha=0.5,show.legend=FALSE)+
       geom_rect(data=s,mapping=aes(xmin=main_harvest_start,xmax=main_harvest_end,ymin=-Inf,ymax=Inf,fill="grey50"),
                 color="black",alpha=0.5,show.legend=FALSE)+
      scale_fill_manual(values=c("gray90","grey50"))+
  geom_text(data=s,aes(x=main_plant_start+0.7,y=0,label="Planting1"),size=3)+
    geom_text(data=s,aes(x=main_harvest_start+0.7,y=0,label="Harvest1"),size=3)+
  new_scale_fill()+
    geom_rect(data=s,mapping=aes(xmin=second_plant_start,xmax=second_plant_end,ymin=-Inf,ymax=Inf,fill="burlywood2"),
              color="black",alpha=0.2,show.legend=FALSE)+
      geom_rect(data=s,mapping=aes(xmin=second_harvest_start,xmax=second_harvest_end,ymin=-Inf,ymax=Inf,fill="thistle"),
                color="black",alpha=0.2,show.legend=FALSE)+
   scale_fill_manual(values=c("burlywood2","thistle"))+
    geom_text(data=s,aes(x=second_plant_start+0.7,y=4,label="Planting2"),size=3,position=position_stack(vjust=1))+
    geom_text(data=s,aes(x=second_harvest_start+0.7,y=4,label="Harvest2"),size=3,position=position_stack(vjust=1))+
      geom_line(data=m, aes(x=month,y=month_avg_real,group=market,color=market),show.legend=FALSE)+
          labs(x="Month",y="Mean Value of Maize per Kilo (2015 Local Currency)") +
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(color="black"))+ ggtitle(paste(sub("-.*","",cclist[i]),"Maize Markets"))
  
print(plot1)

ggsave(paste(sub("-.*","",cclist[i]),"monavg.png",sep="_"))


plot2=ggplot()+
        geom_rect(data=s,mapping=aes(xmin=main_plant_start,xmax=main_plant_end,ymin=-Inf,ymax=Inf,fill="gray90"),
                 color="black",alpha=0.5,show.legend=FALSE)+
       geom_rect(data=s,mapping=aes(xmin=main_harvest_start,xmax=main_harvest_end,ymin=-Inf,ymax=Inf,fill="grey50"),
                 color="black",alpha=0.5,show.legend=FALSE)+
      scale_fill_manual(values=c("gray90","grey50"))+
  geom_text(data=s,aes(x=main_plant_start+0.7,y=max(count(m$month)),label="Planting1"),size=3)+
    geom_text(data=s,aes(x=main_harvest_start+0.7,y=max(count(m$month)),label="Harvest1"),size=3)+
  new_scale_fill()+
    geom_rect(data=s,mapping=aes(xmin=second_plant_start,xmax=second_plant_end,ymin=-Inf,ymax=Inf,fill="burlywood2"),
              color="black",alpha=0.2,show.legend=FALSE)+
      geom_rect(data=s,mapping=aes(xmin=second_harvest_start,xmax=second_harvest_end,ymin=-Inf,ymax=Inf,fill="thistle"),
                color="black",alpha=0.2,show.legend=FALSE)+
   scale_fill_manual(values=c("burlywood2","thistle"))+
     geom_text(data=s,aes(x=second_plant_start+0.7,y=max(count(m$month)),label="Planting2"),size=3,position=position_stack(vjust=0.9))+
    geom_text(data=s,aes(x=second_harvest_start+0.7,y=max(count(m$month)),label="Harvest2"),size=3,position=position_stack(vjust=0.9))+
   new_scale_fill()+
  geom_histogram(data=mx,aes(x=month,fill=monthtype,color=monthtype),binwidth=0.5,position="dodge") +
 scale_color_manual(values=c("turquoise","navyblue"),breaks=c("minmonth","maxmonth"),labels=c("min price","max price"))+
scale_fill_manual(values=c("turquoise","navyblue"),breaks=c("minmonth","maxmonth"),labels=c("min price","max price"))+
  scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"),expand=c(0,0)) + 
   ylab("Number of Months")+
   #scale_y_continuous(name="Number of Months",limits=c(0,max(count(m$month))))+
   theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
         panel.background = element_blank(),axis.line = element_line(color="black"))+
  ggtitle(paste("Minimum and Maximum Month for",sub("-.*","",cclist[i]),"Maize Prices (Primary Season)"))
  
print(plot2)

ggsave(paste(sub("-.*","",cclist[i]),"minmax.png",sep="_"))
}
}


lapply(cclist,monthly.graph)

rm(cclist,s,m,mx,plot1,plot2)

```


A6. Output: Percent Difference in Price by Country
```{r pdiff graphs,echo=FALSE,warning=FALSE,eval=TRUE,paged.print=TRUE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/Country level")
maize_pdiff=season_month%>%
  #unite(country,commodity,col="country_commodity",sep=" - ",remove=FALSE)%>%
 dplyr::select(country,market,year,arb1,pct_arb1)%>%
  mutate(pct_arb100=pct_arb1*100)

clist=unique(maize_pdiff$country)

pdiff.graph = function(clist,na.rm=TRUE){

for (i in seq_along(clist)){

p=subset(maize_pdiff,maize_pdiff$country==clist[i])
  
  
 ca= 
  ggplot() +
    geom_histogram(data=subset(p,p$pct_arb1>0),aes(x=pct_arb1),col="black",fill="grey",bin=0.5,boundary=0,position="dodge") +
   geom_histogram(data=subset(p,p$pct_arb1<0),aes(x=pct_arb1),col="black",fill="red",bin=0.5,boundary=0,position="dodge")+
  # geom_histogram(data=p,aes(x=dpct_p_hh1),col="black",fill="grey")+
  # geom_vline(xintercept=0,color="red")+
 #scale_color_manual(values=c("turquoise","navyblue"),breaks=c("minmonth","maxmonth"),labels=c("min price","max price"))+
#scale_fill_manual(values=c("turquoise","navyblue"),breaks=c("minmonth","maxmonth"),labels=c("min price","max price"))+
  #scale_x_continuous(name="Percent Difference of Planting Price over Harvest Price for Season 1",limits=c(-100,300),breaks=seq(-100,300,50)) + 
  ylab("Number of Market-Year Observations")+xlab("Percent Difference of Planting Price over Harvest Price for Season 1")+
   #scale_y_continuous(name="Number of Months",limits=c(0,max(count(m$month))))+
   theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
         panel.background = element_blank(),axis.line = element_line(color="black"))+
  ggtitle(paste(clist[i]))

 print(ca)
 ggsave(paste(clist[i],"pctdiff.png",sep=""))

}
}

lapply(clist,pdiff.graph)
```

A7. Random figures related to zscore of prices and returns
```{r fig2,echo=FALSE,results='asis', message = FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs")

# z_long=more1_maize%>%
#   dplyr::select(country,market,year,e_returns,contains("hend"),contains("lean"))%>%
#   group_by(country,market)%>%
#   dplyr::mutate(across(hend1:lean2,scale_x),zreturns=scale_x(e_returns))%>%
#   ungroup()%>%
#   pivot_longer(cols=hend1:lean2,names_to="season",values_to="zscore",values_drop_na = TRUE)%>%
#  mutate(season=revalue(season,c("hend1"="hend","hend2"="hend",
#                                  "lean1"="lean","lean2"="lean")))%>%
#  group_by(country,market,year,season)%>%
#   dplyr::summarise_all(~mean(.,na.rm=TRUE))%>%
# #dplyr::summarise(returns=mean(e_returns,na.rm=TRUE),zreturns=mean zscore=mean(zscore,na.rm=TRUE))%>%
#   mutate(zscore=if_else(is.na(zscore),0,zscore),dpct=e_returns*100)
# 
# z_wide=z_long%>%
#   pivot_wider(names_from =season,values_from=c("zscore"))
# 
# 
# # z1=ggplot()+geom_point(data=z_wide,aes(x=hend,y=dpct))+
# #   scale_y_continuous(name="Seasonal Returns (%)",limits=c(-100,500),breaks=seq(-100,500,100)) +  scale_x_continuous(name="Z-score of Harvest Price",limits=c(-3,3),breaks=seq(-3,3,1))+  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"))+geom_vline(xintercept=0,color="red")+geom_hline(yintercept=0,color="red")
# # 
# # print(z1)
# # ggsave("highyear_z1.png")
# 
# 
# # z2=ggplot(data=z_wide,aes(x=hend,y=zreturns))+geom_point()+
# #   #geom_smooth(method="loess",span=0.2,se=F)+
# #   geom_smooth(method="lm",formula=y~splines::bs(x,5),se=F,size=2)+
# #   scale_y_continuous(name="Z-Score of Seasonal Returns",limits=c(-3.5,3.5),breaks=seq(-3.5,3.5,1),expand=c(0,0)) +  scale_x_continuous(name="Z-score of Harvest Price",limits=c(-3.5,3.5),breaks=seq(-3.5,3.5,1),expand=c(0,0))+  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"))+geom_vline(xintercept=0,color="red")+geom_hline(yintercept=0,color="red")
# # 
# # print(z2)
# # ggsave("highyear_z2.png")
# 
# 
# # zbin=z_wide%>%
# #   mutate(bin=cut_interval(hend,length=0.5),probneg=if_else(e_returns<=0,1,0))%>%
# #   group_by(bin)%>%
# #   dplyr::summarise(pneg=mean(probneg))
# # 
# # z_widebin=z_wide%>%
# #   mutate(bin=cut_interval(hend,length=0.5))%>%
# #   left_join(zbin,by=c("bin"))
# 
# # z3=ggplot(data=z_widebin)+geom_point(aes(x=hend,y=zreturns))+
# #   #geom_smooth(method="loess",span=0.2,se=F)+
# #   geom_smooth(aes(x=hend,y=pneg),method="loess",span=0.2,size=2)+ 
# #   scale_y_continuous(name="Z-Score of Seasonal Returns",limits=c(-3.5,3.5),breaks=seq(-3.5,3.5,1),expand=c(0,0)) +  scale_x_continuous(name="Z-score of Harvest Price",limits=c(-3.5,3.5),breaks=seq(-3.5,3.5,1),expand=c(0,0))+  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"))+geom_vline(xintercept=0,color="red")+geom_hline(yintercept=0,color="red")+
# #   geom_text(aes(x=2.75,y=1.25,label=c("Probability of \n Negative Returns")))
# # 
# # print(z3)
# # ggsave("highyear_z3.png")
# 
# # z2=ggplot()+geom_point(data=z_wide,aes(x=dpct,y=hend))+
# #   scale_x_continuous(name="Seasonal Returns (%)",limits=c(-100,500),breaks=seq(-100,500,100)) +  scale_y_continuous(name="Harvest Price",limits=c(0,3),breaks=seq(0,3,0.25))+  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"))+geom_hline(yintercept=0,color="red")
# # #+annotate("label",x=max(mh$zscore),y=300,hjust=0.5,label="7 obs over 300% were omitted")
# # print(z2)
# # ggsave("highyear_z2_hope.png")
# 
# z_wide=z_wide%>%
#   mutate(country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))%>%
#   mutate(market_year=paste0(market,", ",country," (",year,")",sep=""),
#          bin=if_else(dpct<= -50,"Below -50%",if_else(dpct> -50& dpct <0,"-50-0%",
#               if_else(dpct>=0 & dpct<50,"0-50%",if_else(dpct>=50& dpct <100,"50-100%",
#               if_else(dpct>=100 & dpct<150,"100-150%",if_else(dpct>=150& dpct <200,"150-200%",
#                if_else(dpct>=200 & dpct<250,"200-250%",if_else(dpct>=250& dpct <300,"250-300%",if_else(dpct>=300,"Over 300%",as.character(NA)))))))))))%>%
#   mutate(bin=as.factor(bin))
#         
# z_bottom=z_wide%>%
# filter(dpct<=-65)%>%
#   arrange(dpct)%>%
# filter(market%in%c("Sinende","Tshibamba","Bor"))
# 
# z_top=z_wide%>%
#   filter(dpct>300)%>%
#   arrange(desc(dpct))%>%
# filter(market%in%c("Banjul","Beyla","Farafenni"))
# 
# hy=ggplot()+geom_point(data=z_wide,aes(x=hend,y=lean,color=bin),size=0.75,alpha=0.75)+
#   scale_x_continuous(name="Zscore of Harvest Season Price",limits=c(-3.5,3.5),breaks=seq(-3,3,1),expand=c(0,0))+
#   scale_y_continuous(name="Zscore of Lean Season Price",limits=c(-3.5,3.5),breaks=seq(-3,3,1),expand=c(0,0))+
#   scale_color_manual(
#     #values= c("red4","red","lightgreen","green1","green2","green3","green4","forestgreen","darkgreen"),
#      values= c("red4","red","skyblue1","skyblue3","dodgerblue1","dodgerblue3","blue2","blue4","midnightblue"),
#     breaks=c("Below -50%", "-50-0%", "0-50%"," 50-100%", "100-150%","150-200%","200-250%","250-300%","Over 300%"),
#                      name="Seasonal Returns")+
#  # scale_color_gradient2(midpoint=0,low="green",mid="white",high="blue",guide="colorbar",name="Seasonal Returns (%)",limits=c(-100,400))+
#   theme(panel.background = element_blank(),panel.grid.major=element_line(color="lightgray"),
#     panel.grid.minor = element_blank(),axis.line =element_line(color="black"))+   geom_vline(xintercept=0,color="darkgrey")+geom_hline(yintercept=0,color="darkgrey")+
#   guides(color = guide_legend(reverse = TRUE))+
# annotate("label",x=-3,y=3,label="I",color="black",family="serif")+
# annotate("label",x=3,y=3,label="II",color="black",family="serif")+
# annotate("label",x=3,y=-3,label="III",color="black",family="serif")+
# annotate("label",x=-3,y=-3,label="IV",color="black",family="serif")+
#   geom_label_repel(data=z_bottom,aes(hend,lean,label=market_year,hjust =0 ,vjust=0),size =2,color="black")+
#   geom_point(data=z_bottom,aes(x=hend,y=lean,color=bin),size=3,shape=8,show.legend=FALSE)+
#   geom_label_repel(data=z_top,aes(hend,lean,label=market_year,hjust = 1,vjust=0),size =2,color="black")+
# geom_point(data=z_top,aes(x=hend,y=lean,color=bin),size=3,shape=8,show.legend=FALSE)
#               
#               
# print(hy)
# ggsave("highyear_returns.png")
# 
# 
# #h1=lm(e_returns~-1+hend+lean+factor(year)+factor(country),data=z_wide)
# #summary(h1)
# 
# #stargazer(h1,style="aer",keep.stat = "adj.rsq",align=TRUE,no.space=TRUE,report="vc*")
# 
# rm(mh1,mh2,z_widebin,z_long,h1,z1,z2,z3,hy,z_bottom,z_top,z_wide,zbin)
rm(z1)

```


A8. (tbd) PDFs and CDF
```{r pdf cdf}

# setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R/output")
# 
# pdf_facet=ggplot()+geom_density(data=temp_long,aes(payoff,fill=factor(choice)),alpha=0.5)+
#   geom_vline(data=mean,aes(xintercept=payoff.mean,colour=choice),linetype="dashed", size=0.5,position="dodge", show.legend=FALSE)+
#   scale_fill_manual(values=c("blue","gray"),breaks=c("payoff_nostore","payoff_store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_color_manual(values=c("blue","gray"),breaks=c("payoff_nostore","payoff_store"))+
#   xlab("Net Payoff over Harvest and Lean Season")+
#    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
#          panel.background = element_blank(),axis.line = element_line(color="black"),
#            legend.justification=c(1,0), legend.position=c(1,0.5))+
#   ggtitle(paste(clist[i]))
# 
# print(pdf_list[[paste("pdf",clist[i])]])
# ggsave(paste(clist[i],"_pdf.png",sep=""))
# 
# 
# cdf_list[[paste("cdf",clist[i])]]=ggplot()+stat_ecdf(data=temp_long,aes(payoff,color=factor(choice)),geom="step",size=1,position="identity")+
#   geom_vline(data=mean, aes(xintercept=payoff.mean,colour=choice),linetype="dashed", size=0.5,alpha=0.5,position="dodge",show.legend=FALSE)+
#  scale_color_manual(values=c("blue","gray"),breaks=c("payoff_nostore","payoff_store"),labels=c("No storage","Storage"),name="Choice")+
#   #xlab("Net Payoff over Harvest and Lean Season")+
#    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
#          panel.background = element_blank(),axis.line = element_line(color="black"),
#            legend.justification=c(1,0), legend.position=c(1,0.5))+
#   ggtitle(paste(clist[i]))
# 
# print(cdf_list[[paste("cdf",clist[i])]])
# ggsave(paste(clist[i],"_cdf.png",sep=""))


```


A9 (tbd) Analysis and output for paper 1: Stochastic dominance
```{r sd,echo=FALSE,results='asis', message = FALSE}
# 
# 
# setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R/output")
# 
# 
# #create sequence of storage losses from 0-100%
# alpha_val=seq(0.00,0.75,by=0.01)
# 
# alpha_results=data.frame(country=character(),equal_test=numeric(),e_store=numeric(),e_nostore=numeric(),
#     FOSD=character(),p_d_within=numeric(),SOSD=character(),p_s_within=numeric(),TOSD=character(),p_t_within=numeric(),alpha=numeric())
# 
# 
# for (a in alpha_val){
# 
# maize_dom=more1_maize%>%
#   #dplyr::select(country,market,year,planting1,hend1,planting2,hend2,yield_kgha)%>%
#     dplyr::select(country,market,year,lean1,hend1,lean2,hend2,yield_kgha)%>%
#   mutate(alpha=a,k=.5)%>%
#   mutate(store_1=yield_kgha*(1-alpha)*lean1-k*ceiling(yield_kgha/50),
#        nostore_1=yield_kgha*hend1,
#        store_2=yield_kgha*(1-alpha)*lean2-k*ceiling(yield_kgha/50),
#      nostore_2=yield_kgha*hend2)%>%
#   # mutate(store_1=yield_kgha*(1-alpha)*planting1-k*ceiling(yield_kgha/50),
#   #        nostore_1=yield_kgha*hend1,
#   #         store_2=yield_kgha*(1-alpha)*planting2-k*ceiling(yield_kgha/50),
#   #        nostore_2=yield_kgha*hend2)%>%
#   pivot_longer(cols=store_1:nostore_2,names_to=c(".value","season"),names_sep="_",values_drop_na = TRUE)%>%
# group_by(country,market,year)%>%
#   dplyr::summarise(payoff_store=mean(store,na.rm=TRUE),payoff_nostore=mean(nostore,na.rm=TRUE))#average across payoffs for 2 season market-years
# 
# #write_dta(maize_dom,"c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Stata/Data/maize_dom_072020.dta")
# 
# sd_results=data.frame(country=character(),equal_test=numeric(),e_store=numeric(),e_nostore=numeric(),
#       p_d_equal=numeric(),d1max=numeric(),d2max=numeric(),d_hat=numeric(),FOSD=character(),p_d_within=numeric(),
#       p_s_equal=numeric(),s1max=numeric(),s2max=numeric(),s_hat=numeric(),SOSD=character(),p_s_within=numeric(),
#       p_t_equal=numeric(),t1max=numeric(),t2max=numeric(),t_hat=numeric(),TOSD=character(),p_t_within=numeric())
# 
#   
# clist=unique(maize_dom$country)
# pdf_list<-list()
# cdf_list<-list()
# 
# #loop over countries
# for (i in seq_along(clist)){
# 
# temp_wide=maize_dom%>%
#   #filter(country=="Malawi")
#   filter(country==clist[i])
#   
# temp_long=temp_wide%>%
#   pivot_longer(cols=starts_with("payoff"),names_to="choice",values_to="payoff",values_drop_na = TRUE)%>%
#   arrange(payoff)
# 
# store.ecdf=ecdf(temp_wide$payoff_store)
# nostore.ecdf=ecdf(temp_wide$payoff_nostore)
# 
# n_0 <- length(temp_wide$payoff_store)
# n_1 <- length(temp_wide$payoff_nostore)
# n_total=n_0+n_1
# N=sqrt((n_0*n_1)/(n_total))
# 
# plist=unique(temp_long$payoff)
# 
# p=data.frame(payoff=plist)%>%
#   mutate(f1_hat=store.ecdf(payoff), f2_hat=nostore.ecdf(payoff))%>%
#   mutate(d1=f1_hat-f2_hat,d2=f2_hat-f1_hat)%>%
#   arrange(payoff)
# 
# #p_int=p[-1,]
# p_int=p[-nrow(p),] #the last line will be equal to 0 by design, so drop it for identifying d1max,d2max, and d_hat_eq
# 
# d1max=max(p_int$d1)
# d2max=max(p_int$d2)
# d_hat_eq=N*max(d1max,d2max) #this is baseline for the K-S test of equality to compare to d_star_eq generated through Abadie (2002) resampling procedure below
# d_hat=N*min(d1max,d2max) #this is for FOSD "observation" test, the FOSD test using Massoumi & Heshmati (2000) follows 
# 
# #FOSD "observation" test
# #technically for FOSD, dhat<=0 and d1<0 for atleast *one* payoff implies storing FOSD, so need to account for existence, but not persistence of zero because even if d1max=0 , as long as d2max>0, it means that at least one d1 is negative (and similarly for d2 and no storage scenario)
# FOSD=if_else(d_hat<=0 & d1max<=0 & d2max>0,"storing",if_else(d_hat<=0 & d2max<=0 & d1max>0,"no storage",if_else(d_hat>0,"no rank",as.character(NA))))
# 
# p$s1=cumsum(p$d1)
# p$s2=cumsum(p$d2)
# 
# s1max=max(p$s1)
# s2max=max(p$s2)
# s_hat_eq=N*max(s1max,s2max) #this is not used
# s_hat=N*min(s1max,s2max) #this is for SOSD "observation" test
# 
# #SOSD "observation" test (same explanation for above)
# SOSD=if_else(s_hat<=0 & s1max<=0&s2max>0,"storing",if_else(s_hat<=0 & s2max<=0 & s1max>0,"no storage",if_else(s_hat>0,"no rank",as.character(NA))))
# 
# p$t1=cumsum(p$s1)
# p$t2=cumsum(p$s2)
# 
# t1max=max(p$t1)
# t2max=max(p$t2)
# t_hat_eq=N*max(t1max,t2max)#this is not used
# t_hat=N*min(t1max,t2max)#this is for TOSD "observation" test
# 
# #TOSD "observation" test
# TOSD=if_else(t_hat<=0 & t1max<=0& t2max>0,"storing",if_else(t_hat<=0 & t2max<=0 & t1max>0,"no storage",if_else(t_hat>0,"no rank",as.character(NA))))
# 
# 
# ##BOOTSTRAP for test of equality following Abadie (2002)
# #p-value for d should equal to k1
# bootresults_equal=data.frame(d_star_eq=numeric(),s_star_eq=numeric(),t_star_eq=numeric())
# 
# for(j in 1:500)
# {
# 
# n_0 <- length(temp_wide$payoff_store)
# n_1 <- length(temp_wide$payoff_nostore)
# n_total=n_0+n_1
# n_01=n_0+1
# N=sqrt((n_0*n_1)/(n_total))
# 
# samp=sample(temp_long$payoff,size=n_total,replace=TRUE)
# samp1=samp[1:n_0]
# samp2=samp[n_01:n_total]
# 
# 
# store2.ecdf=ecdf(samp1)
# nostore2.ecdf=ecdf(samp2)
# 
# slist=unique(samp)
# 
# p2=data.frame(payoff=slist)%>%
#   mutate(f1_hat=store2.ecdf(payoff), f2_hat=nostore2.ecdf(payoff))%>%
#   mutate(d1=f1_hat-f2_hat,d2=f2_hat-f1_hat)%>%
#   arrange(payoff)
# 
# #p2_int=p2[-1,]
# p2_int=p2[-nrow(p2),] #the last line will be equal to 0 by design, so drop it for identifying d1maxx,d2maxx, and d_star_eq
# 
# 
# d1maxx=max(p2_int$d1)
# d2maxx=max(p2_int$d2)
# d_star_eq=N*max(d1maxx,d2maxx)
# 
# p2$s1=cumsum(p2$d1)
# p2$s2=cumsum(p2$d2)
# 
# s1maxx=max(p2$s1)
# s2maxx=max(p2$s2)
# s_star_eq=N*max(s1maxx,s2maxx)
# 
# p2$t1=cumsum(p2$s1)
# p2$t2=cumsum(p2$s2)
# 
# t1maxx=max(p2$t1)
# t2maxx=max(p2$t2)
# t_star_eq=N*max(t1maxx,t2maxx)
# 
# bootresults_equal[j,1]<-d_star_eq
# bootresults_equal[j,2]<-s_star_eq
# bootresults_equal[j,3]<-t_star_eq
# 
# }
# 
# # xlist=c("d","s","t")
# # 
# # for (x in xlist)
# # {
# # bootresults_equal[[paste0("I",x)]]<-if_else(bootresults_equal[[paste0(x,"_star_eq")]]>paste0(x,"_hat_eq"),1,0)
# # #paste0("pval_",x,"_equal")<-mean(bootresults_equal[[paste0("I",x)]])
# # 
# # }
# 
# bootresults_equal$Id=if_else(bootresults_equal$d_star_eq>d_hat_eq,1,0)
# bootresults_equal$Is=if_else(bootresults_equal$s_star_eq>s_hat_eq,1,0)
# bootresults_equal$It=if_else(bootresults_equal$t_star_eq>t_hat_eq,1,0)
# 
# pval_d_equal=mean(bootresults_equal$Id)
# pval_s_equal=mean(bootresults_equal$Is)
# pval_t_equal=mean(bootresults_equal$It)
# 
# 
# #K-S test for equality of distributions
# k1=ks.boot(temp_wide$payoff_store,temp_wide$payoff_nostore,nboots=500,alternative="t",print.level=0)$ks.boot.pvalue
# #k1=round(k1,digits=4)
# 
# #k2=dgof::ks.test(temp_wide$payoff_store,temp_wide$payoff_nostore,tol=1e-8, simulate.p.value=TRUE, B=500)$ks.test.pvalue
# #k2=round(k2,digits=4)
# 
# 
# #Resampling within sample only for stochastic dominance tests following M & H (2000)
# bootresults_within=data.frame(d_star_within=numeric(),s_star_within=numeric(),t_star_within=numeric())
# 
# for(h in 1:500)
# {
#   
# n_0 <- length(temp_wide$payoff_store)
# n_1 <- length(temp_wide$payoff_nostore)
# n_total=n_0+n_1
# N=sqrt((n_0*n_1)/(n_total))
# 
# samp1=sample(temp_wide$payoff_store,size=n_0,replace=TRUE)
# samp2=sample(temp_wide$payoff_nostore,size=n_1,replace=TRUE)
# 
# store2.ecdf=ecdf(samp1)
# nostore2.ecdf=ecdf(samp2)
# 
# samp=c(samp1,samp2)
# slist=unique(samp)
# 
# p2=data.frame(payoff=slist)%>%
#   mutate(f1_hat=store2.ecdf(payoff), f2_hat=nostore2.ecdf(payoff))%>%
#   mutate(d1=f1_hat-f2_hat,d2=f2_hat-f1_hat)%>%
#   arrange(payoff)
# 
# #p2_int=p2[-1,]
# p2_int=p2[-nrow(p2),]#the last line will be equal to 0 by design, so drop it for identifying d1maxx,d2maxx, and d_star_within
# 
# d1maxx=max(p2_int$d1)
# d2maxx=max(p2_int$d2)
# d_star_within=N*min(d1maxx,d2maxx)
# 
# p2$s1=cumsum(p2$d1)
# p2$s2=cumsum(p2$d2)
# 
# s1maxx=max(p2$s1)
# s2maxx=max(p2$s2)
# s_star_within=N*min(s1maxx,s2maxx)
# 
# p2$t1=cumsum(p2$s1)
# p2$t2=cumsum(p2$s2)
# 
# t1maxx=max(p2$t1)
# t2maxx=max(p2$t2)
# t_star_within=N*min(t1maxx,t2maxx)
# 
# bootresults_within[h,1]<-d_star_within
# bootresults_within[h,2]<-s_star_within
# bootresults_within[h,3]<-t_star_within
# 
# }
# 
# bootresults_within$Id=if_else(bootresults_within$d_star_within<=0,1,0)
# bootresults_within$Is=if_else(bootresults_within$s_star_within<=0,1,0)
# bootresults_within$It=if_else(bootresults_within$t_star_within<=0,1,0)
# 
# # xlist=c("d","s","t")
# # 
# # for (x in xlist)
# # {
# # bootresults_within[[paste0("I",x)]]<-if_else(bootresults_within[[paste0(x,"_star_eq")]]<=0,1,0)
# # #paste0("pval_",x,"_equal")<-mean(bootresults_equal[[paste0("I",x)]])
# # 
# # }
# 
# pval_d_within=mean(bootresults_within$Id)
# pval_s_within=mean(bootresults_within$Is)
# pval_t_within=mean(bootresults_within$It)
# 
# 
# e_store<-mean(temp_wide$payoff_store,na.rm=TRUE)
# e_nostore<-mean(temp_wide$payoff_nostore,na.rm=TRUE)
# 
# country_results=data.frame(country=clist[i],k1,e_store,e_nostore,
#                       pval_d_equal,d1max,d2max,d_hat,FOSD,pval_d_within,
#                       pval_s_equal,s1max,s2max,s_hat,SOSD,pval_s_within,
#                       pval_t_equal,t1max,t2max,t_hat,TOSD,pval_t_within)
# 
# 
# sd_results=rbind(sd_results,country_results)
# 
# 
# # pdf_list[[paste("pdf",clist[i])]]=ggplot()+geom_density(data=temp_long,aes(payoff,fill=factor(choice)),alpha=0.5)+
# #   geom_vline(data=mean,aes(xintercept=payoff.mean,colour=choice),linetype="dashed", size=0.5,position="dodge", show.legend=FALSE)+
# #   scale_fill_manual(values=c("blue","gray"),breaks=c("payoff_nostore","payoff_store"),labels=c("No storage","Storage"),name="Choice")+
# #   scale_color_manual(values=c("blue","gray"),breaks=c("payoff_nostore","payoff_store"))+
# #   xlab("Net Payoff over Harvest and Lean Season")+
# #    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
# #          panel.background = element_blank(),axis.line = element_line(color="black"),
# #            legend.justification=c(1,0), legend.position=c(1,0.5))+
# #   ggtitle(paste(clist[i]))
# # 
# # print(pdf_list[[paste("pdf",clist[i])]])
# # ggsave(paste(clist[i],"_pdf.png",sep=""))
# # 
# # 
# # cdf_list[[paste("cdf",clist[i])]]=ggplot()+stat_ecdf(data=temp_long,aes(payoff,color=factor(choice)),geom="step",size=1,position="identity")+
# #   geom_vline(data=mean, aes(xintercept=payoff.mean,colour=choice),linetype="dashed", size=0.5,alpha=0.5,position="dodge",show.legend=FALSE)+
# #  scale_color_manual(values=c("blue","gray"),breaks=c("payoff_nostore","payoff_store"),labels=c("No storage","Storage"),name="Choice")+
# #   #xlab("Net Payoff over Harvest and Lean Season")+
# #    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
# #          panel.background = element_blank(),axis.line = element_line(color="black"),
# #            legend.justification=c(1,0), legend.position=c(1,0.5))+
# #   ggtitle(paste(clist[i]))
# # 
# # print(cdf_list[[paste("cdf",clist[i])]])
# # ggsave(paste(clist[i],"_cdf.png",sep=""))
# 
# }
# 
# x_results=sd_results%>%
#   dplyr::select(-contains("equal"),-contains("max"),-contains("hat"))%>%
#  mutate(alpha=a)
# 
# 
# 
# 
# 
# #alpha_results=rbind(alpha_results,x_results)
# 
# alpha_results=rbind(alpha_results,x_results)
# 
# #assign(paste("x_results",a,sep="_"),x)
# 
# 
# }
# 
# 
# 
# 
# loss_5_lean=alpha_results%>%
#   filter(alpha==0.05)%>%
#   # mutate(FOSD_star=if_else(pval_d_within>=0.9&pval_d_within<0.95,"*",if_else(pval_d_within>0.95&pval_d_within<0.99,"**",
#   #                                                                            if_else(pval_d_within>0.99,"***"," "))),
#   #        SOSD_star=if_else(pval_s_within>=0.9&pval_s_within<0.95,"*",if_else(pval_s_within>0.95&pval_s_within<0.99,"**",
#   #                                                                             if_else(pval_s_within>0.99,"***"," "))),
#   #       TOSD_star=if_else(pval_t_within>=0.9&pval_t_within<0.95,"*",if_else(pval_t_within>0.95&pval_t_within<0.99,"**",                                                                                                                    if_else(pval_t_within>0.99,"***"," "))))%>%
#   #   mutate(FOSD_star=if_else(FOSD!="no rank"&FOSD_star!=" ",paste0(FOSD,FOSD_star),FOSD_star),
#   #          SOSD_star=if_else(SOSD!="no rank"&SOSD_star!=" ",paste0(SOSD,SOSD_star),SOSD_star),
#   #          TOSD_star=if_else(TOSD!="no rank"&TOSD_star!=" ",paste0(TOSD,TOSD_star),TOSD_star),
#   mutate(FOSD_p=if_else(pval_d_within>=0.9,paste0(FOSD," (",sprintf(pval_d_within,fmt='%#.3f'),")")," "),
#          SOSD_p=if_else(pval_s_within>=0.9,paste0(SOSD," (",sprintf(pval_s_within,fmt='%#.3f'),")")," "),
#           TOSD_p=if_else(pval_t_within>=0.9,paste0(SOSD," (",sprintf(pval_t_within,fmt='%#.3f'),")")," "),
#           e_store=paste0("$",sprintf(e_store,fmt='%#.2f')),e_nostore=paste0("$",sprintf(e_nostore,fmt='%#.2f')),
#            #e_store=paste0("$",round(e_store,2)),e_nostore=paste0("$",round(e_nostore,2)),
#          country=revalue(country,c("Democratic Republic of the Congo"="DR Congo")))%>%
#   dplyr::select(1:4,contains("_p"))
# 
# x1=xtable(loss_5_lean,type="latex",auto=TRUE)
# names(x1)<-c("Country","K-S Test of Equality","E[Payoff_storage])","E[Payoff_no storage]", "FOSD p(d*<=0)","SOSD p(s*<=0)","TOSD p(t*<=0)")
# align(x1)<-"l|l|c|c|c|c|c|c|"
# 
# setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R/output")
# print(x1,file="sd_results_lean.tex",digits=3,include.rownames=FALSE)
# 
# 
# # loss_5_planting=alpha_results%>%
# #   filter(alpha==0.05)%>%
# #   mutate(FOSD_star=if_else(pval_d_within>=0.9&pval_d_within<0.95,"*",if_else(pval_d_within>0.95&pval_d_within<0.99,"**",
# #                                                                              if_else(pval_d_within>0.99,"***"," "))),
# #          SOSD_star=if_else(pval_s_within>=0.9&pval_s_within<0.95,"*",if_else(pval_s_within>0.95&pval_s_within<0.99,"**",
# #                                                                               if_else(pval_s_within>0.99,"***"," "))), 
# #         TOSD_star=if_else(pval_t_within>=0.9&pval_t_within<0.95,"*",if_else(pval_t_within>0.95&pval_t_within<0.99,"**",                                                                                                                    if_else(pval_t_within>0.99,"***"," "))))%>%
# #     mutate(FOSD_star=if_else(FOSD!="no rank"&FOSD_star!=" ",paste0(FOSD,FOSD_star),FOSD_star),
# #            SOSD_star=if_else(SOSD!="no rank"&SOSD_star!=" ",paste0(SOSD,SOSD_star),SOSD_star),
# #            TOSD_star=if_else(TOSD!="no rank"&TOSD_star!=" ",paste0(TOSD,TOSD_star),TOSD_star),
# #            e_store=paste0("$",round(e_store,2)),e_nostore=paste0("$",round(e_nostore,2)))%>%
# #   dplyr::select(1:4,contains("star"))
# # 
# # x2=xtable(loss_5_planting,type="latex")
# # names(x2)<-c("Country","Test of Equality","E(payoff.store)","E(payoff.nostore)", "FOSD p(d*<=0)","SOSD p(s*<=0)","TOSD p(t*<=0)")
# # 
# # setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R/output")
# # print(x2,file="sd_results_planting.tex",digits=3,include.rownames=FALSE)
# 
# 
# a_results=alpha_results%>%
#   arrange(country,alpha)%>%
#   mutate(f_nostore=if_else(FOSD=="no storage"& pval_d_within>=0.9,alpha,as.numeric(NA)),
#          s_nostore=if_else(SOSD=="no storage"& pval_s_within>=0.9,alpha,as.numeric(NA)),
#          t_nostore=if_else(TOSD=="no storage"& pval_t_within>=0.9,alpha,as.numeric(NA)),
#     f_store=if_else(FOSD=="storing"& pval_d_within>=0.9,alpha,as.numeric(NA)),
#      s_store=if_else(SOSD=="storing"& pval_s_within>=0.9,alpha,as.numeric(NA)),
#       t_store=if_else(TOSD=="storing"& pval_t_within>=0.9,alpha,as.numeric(NA)))%>%
#   group_by(country)%>%
#   dplyr::summarise(across(f_nostore:t_nostore,min,na.rm=TRUE),across(f_store:t_store,max,na.rm=TRUE))%>%
#  mutate_if(is.numeric, function(x) ifelse(is.infinite(x),as.numeric(NA),x*100))
# 
# alpha_val=seq(0,100,by=1)
# 
# order1=c("t_store","s_store","f_store")
# order2=c("t_nostore","s_nostore","f_nostore")
# 
# for (o in order1){
# for (a in seq_along(alpha_val)){
#   a_results[[paste("a",a,sep="")]]<-if_else(!is.na(a_results[[o]])&a_results[[o]]>=a,o,a_results[[paste("a",a,sep="")]])
# }
# }
# 
# for (o in order2){
# for (a in seq_along(alpha_val)){
#   a_results[[paste("a",a,sep="")]]<-if_else(!is.na(a_results[[o]])&a_results[[o]]<=a,o,a_results[[paste("a",a,sep="")]])
# }
# }
# 
# results=a_results%>%
#   dplyr::select(country,starts_with("a"))%>%
#  pivot_longer(cols=a1:a101,names_to="loss_pct",values_to="order",values_drop_na = FALSE)%>%
#   mutate(loss_pct=as.numeric(gsub("a","",loss_pct)),country=revalue(country,c("Democratic Republic of the Congo"="DR Congo")))
# #%>%
#   #separate(order,c("level","choice"))%>%
#   #mutate(l_choice=paste(level,choice,sep="_"))
# 
# 
# #library(extrafont) 
# #font_import(pattern = "lmodern*") 
# #loadfonts()
# sd=ggplot()+
#     #geom_point(size=1)+
#   geom_path(data=subset(results,loss_pct<=50),aes(x=loss_pct,y=reorder(country,desc(country)),color=order,group=country),size=2)+
#  scale_color_manual(name="Stochastic Dominance",values=c("purple4","royalblue","green","red","orange","yellow2","white"),
#                      breaks=c("f_store","s_store","t_store","f_nostore","s_nostore","t_nostore","NA"),labels=c("Store (FOSD)","Store (SOSD)","Store (TOSD)","No storage (FOSD)","No storage (SOSD)","No storage (TOSD)"," "))+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"),axis.title.y = element_blank(),
#         #axis.text.y = element_blank(),axis.ticks.y=element_blank(),
#         axis.title.x=element_text(face="bold"),
#         plot.margin=margin(-0.5,-0.5,-0.5,-0.5,"pt"), panel.margin = unit(0,"null"),
#         text= element_text(family="serif"))+
#   scale_x_continuous(name="Storage Loss (%)",limits=c(0,50),breaks=seq(0,50,10),expand=c(0,0),position="top")
# 
# print(sd)
# setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R/output")
# ggsave("storageloss.png")
# 
# 
# 
# # names(loss_5_lean)<-c("Country","K-S Test of\n Equality","Expected Payoff \n storage","Expected Payoff \n no storage", "FOSD\np(d*<=0)","SOSD\np(s*<=0)","TOSD\np(t*<=0)")
# # 
# # 
# # footnotes<-"1:K-S Test: See Section 3.1. For p<0.1, we can reject the null hypothesis of equality of the distributions \n 2:Rank: See Section 3.2. If x≤0, the distribution with x≤0 is observed to be dominant, for x=d,s,t.\n 3. Probability:  See  Section  3.2. If p(x∗)≤0  is  greater  than  or  equal  to  0.9,  we  can  obtain  90%  or  greater  confidence \n that the distribution with x <0 is dominant, for x=d,s,t. n\ The probability is included in parentheses, for probabilities greater than orequal to 0.9."
# # 
# # 
# # theme_1 <- ttheme_minimal(core = list(fg_params = list(hjust = 0, 
# #                                                            x = 0.1, 
# #                                                     fontsize = 9)),
# #                           colhead = list(fg_params = list(fontsize = 12, 
# #                                                           fontface = "bold")))
# # 
# # lg=ggtexttable(loss_5_lean,rows = NULL,theme="classic")%>% 
# #   tab_add_hline(at.row = 2, row.side = "top", linewidth = 2)%>%
# #   tab_add_border()%>%
# #    tab_add_footnote(text = footnotes, size = 10)
# # 
# # #g=ggarrange(lg,sd,ncol = 2, nrow = 1,heights=c(2,2),widths=c(4,2),align="h")
# # #ggsave(g,"storageloss_table.png")
# # 
# # 
# # grid.newpage()
# # s=ggplotGrob(sd)
# # lg=tableGrob(loss_5_lean,rows = NULL,theme = theme_1)
# # 
# # l=gtable(unit(1:2,c("cm")),unit(5,"cm"))
# # l         
# # l=gtable_add_grob(l,lg,1,1)
# # l=gtable_add_grob(l,s,1,2, clip = "inherit")
# # 
# # # th <- sum(lg$heights)
# # # pg <- arrangeGrob(lg, s, ncol=2,heights = unit.c(th, unit(1,"npc")-th))
# # # grid.draw(pg)
# # 
# # #%>% 
# #   #tab_add_hline(at.row = 2, row.side = "top", linewidth = 2)%>%
# #   #tab_add_border()%>%
# #    #tab_add_footnote(text = footnotes, size = 10)
# # 
# # lg=tableGrob(loss_5_lean,rows = NULL,theme = theme_1)%>%
# #   tab_add_border()%>%
# #   tab_add_footnote(text = footnotes, size = 10)
# # 
# # grid.newpage()
# # figA=arrangeGrob(lg,ncol=1,heights=c(10,1))
# # figB=arrangeGrob(sd,ncol=1,heights=c(10,1))
# # finalfig=ggarrange(figA,figB,align="v")
# 
# 
# 
# rm(samp,samp1,samp2,store2.ecdf,nostore2.ecdf,n_01,n_total,slist,h,i,j,country_results,temp_long,temp_wide,plist,k1,k2,N,n_0,n_1,FOSD,SOSD,TOSD,store.ecdf,nostore.ecdf,p,p2,p2_int,bootresults_equal,bootresults_within,mean,a,alpha_val,e_nostore,e_store,loss,x_results,p_int,o,order1,order2)
# rm(list=ls(pattern="pval"))
# rm(list=ls(pattern="star"))
# rm(list=ls(pattern="max"))
# rm(list=ls(pattern="hat"))
# rm(list=ls(pattern="maxx"))


```





